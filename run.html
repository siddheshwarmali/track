
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Run Dashboard</title>

  <!-- CDN dependencies (same as your original run.html) -->
  <script src="https://cdn.tailwindcss.com" defer></script>
  <script src="https://unpkg.com/lucide@latest" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>

  <style>
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px;line-height:18px;}
    .badge-green{background:#dcfce7;color:#166534;border:1px solid #bbf7d0;}
    .badge-yellow{background:#fef9c3;color:#854d0e;border:1px solid #fde68a;}
    .badge-red{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;}
  </style>

  <!-- Auth / nav (kept compatible with your original run.html behavior) -->
  <script>
    async function twJson(url, opt){
      opt = opt || {};
      const r = await fetch(url, {
        credentials:'same-origin',
        headers:{'Accept':'application/json','Content-Type':'application/json'},
        ...opt
      });
      const t = await r.text();
      let j = {};
      try{ j = JSON.parse(t || '{}'); }catch(e){ j = {error:t}; }
      if(!r.ok) throw new Error(j.error || j.message || t || ('HTTP '+r.status));
      return j;
    }

    async function twInit(){
      try{
        const me = await twJson('/api/auth/me');
        if(!me || !me.authenticated){
          const next = encodeURIComponent(location.pathname + location.search + location.hash);
          location.replace('/login.html?next='+next);
          return;
        }
        window.twMe = me;

        const pill = document.getElementById('tw-userpill');
        if(pill) pill.textContent = (me.userId||'User') + ' ‚Ä¢ ' + (me.role||'viewer');

        const eb = document.getElementById('tw-execboard');
        if(eb){
          const perms = me.permissions || {};
          eb.classList.toggle('hidden', !((me.role==='admin') || perms.executiveBoard));
        }

        const um = document.getElementById('tw-usermgr');
        if(um) um.classList.toggle('hidden', me.role!=='admin');

        const lo = document.getElementById('tw-logout');
        if(lo) lo.onclick = async ()=>{
          try{ await twJson('/api/auth/logout',{method:'POST',body:'{}'}); }catch(e){}
          location.href='/login.html';
        };
      }catch(e){
        const next = encodeURIComponent(location.pathname + location.search + location.hash);
        location.replace('/login.html?next='+next);
      }
    }
    window.addEventListener('DOMContentLoaded', ()=>twInit());
  </script>

  <!-- state-client.js (INLINE) -->
  <script>
    (function(global){
      'use strict';
      function toQS(p){
        var e=encodeURIComponent,a=[];
        for(var k in p){
          if(!Object.prototype.hasOwnProperty.call(p,k)) continue;
          if(p[k]===undefined || p[k]===null) continue;
          a.push(e(k)+'='+e(String(p[k])));
        }
        return a.length ? ('?'+a.join('&')) : '';
      }
      function safeParse(t,fb){ try{return JSON.parse(t||'');}catch(e){return fb;} }
      function req(url,opt){
        opt=opt||{};
        var h=opt.headers||{};
        h['Accept']=h['Accept']||'application/json';
        if(opt.body!==undefined && opt.body!==null) h['Content-Type']=h['Content-Type']||'application/json';
        return fetch(url,{
          method:opt.method||'GET',
          credentials:'same-origin',
          headers:h,
          body:(opt.body!==undefined && opt.body!==null)
            ? (typeof opt.body==='string' ? opt.body : JSON.stringify(opt.body))
            : undefined
        }).then(function(r){
          return r.text().then(function(t){
            var j=safeParse(t,{error:t});
            if(!r.ok) throw new Error((j&&(j.error||j.message))||t||('HTTP '+r.status));
            return j;
          });
        });
      }
      global.StateApi={
        list:function(){return req('/api/state'+toQS({list:1}),{method:'GET'}).then(d=>(d&&d.dashboards)||[]);},
        get:function(id){return req('/api/state'+toQS({dash:id}),{method:'GET'});},
        save:function(id,state,name){return req('/api/state'+toQS({dash:id}),{method:'POST',body:{state:state,name:name}});},
        merge:function(id,patch){return req('/api/state'+toQS({dash:id,merge:1}),{method:'POST',body:{patch:patch}});},
        publish:function(id,body){return req('/api/state'+toQS({dash:id,publish:1}),{method:'POST',body:body||{}});},
        unpublish:function(id){return req('/api/state'+toQS({dash:id,unpublish:1}),{method:'POST',body:{}});},
        remove:function(id){return req('/api/state'+toQS({dash:id}),{method:'DELETE',body:{}});}
      };
    })(window);
  </script>

  <!-- run-app.js (INLINE, fixed + robust) -->
  <script>
    (function(){'use strict';
      var tickets=[];
      var pieChart=null, barChart=null;
      var thresholds={Small:4,Medium:6,Large:8};

      function qs(id){return document.getElementById(id);}
      function dashId(){try{return new URL(location.href).searchParams.get('dash')||'';}catch(e){return ''}}
      function esc(s){return String(s||'').replace(/[&<>"']/g,function(c){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c];});}
      function toast(msg,kind){
        var t=qs('toast'); if(!t) return;
        t.textContent=msg; t.classList.remove('hidden');
        t.classList.remove('bg-emerald-600','bg-red-600','bg-slate-900');
        t.classList.add(kind==='error'?'bg-red-600':(kind==='ok'?'bg-emerald-600':'bg-slate-900'));
        clearTimeout(toast._timer); toast._timer=setTimeout(function(){t.classList.add('hidden');},2600);
      }

      function computeTotals(){
        var total=tickets.length,onTime=0;
        for(var i=0;i<tickets.length;i++){
          var t=tickets[i]||{};
          if(Number(t.actualTime)<=Number(t.threshold)) onTime++;
        }
        var breached=total-onTime;
        var sla=total?((onTime/total)*100).toFixed(1):'0.0';
        return{total:total,onTime:onTime,breached:breached,sla:sla};
      }

      function buildBarData(){
        var map={};
        for(var i=0;i<tickets.length;i++){
          var t=tickets[i]||{};
          var tp=t.type||'Medium';
          if(!map[tp]) map[tp]={type:tp,total:0,onTime:0,breached:0,totalTime:0};
          map[tp].total++;
          map[tp].totalTime+=Number(t.actualTime||0);
          if(Number(t.actualTime)<=Number(t.threshold)) map[tp].onTime++;
          else map[tp].breached++;
        }
        var arr=[]; for(var k in map) if(Object.prototype.hasOwnProperty.call(map,k)) arr.push(map[k]);
        var order={Small:1,Medium:2,Large:3};
        arr.sort(function(a,b){return (order[a.type]||99)-(order[b.type]||99) || a.type.localeCompare(b.type);});
        return arr;
      }

      function renderKPIs(t){
        if(qs('kpiTotal')) qs('kpiTotal').textContent=String(t.total);
        if(qs('kpiOnTime')) qs('kpiOnTime').textContent=String(t.onTime);
        if(qs('kpiBreached')) qs('kpiBreached').textContent=String(t.breached);
        if(qs('kpiSla')) qs('kpiSla').textContent=t.sla+'%';
      }

      function renderCharts(totals,barData){
        if(typeof Chart==='undefined'){toast('Chart.js not loaded','error');return;}
        if(typeof ChartDataLabels!=='undefined'){ try{Chart.register(ChartDataLabels);}catch(e){} }
        var pie=qs('pieChart'), bar=qs('barChart');
        if(!pie || !bar) return;

        if(pieChart) pieChart.destroy();
        pieChart=new Chart(pie.getContext('2d'),{
          type:'doughnut',
          data:{labels:['On Time','Breached'],datasets:[{data:[totals.onTime,totals.breached],backgroundColor:['#10b981','#ef4444'],borderWidth:0}]},
          options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'},datalabels:{color:'#111',font:{weight:'bold'},formatter:function(v){return v;}}}}
        });

        if(barChart) barChart.destroy();
        barChart=new Chart(bar.getContext('2d'),{
          type:'bar',
          data:{
            labels:barData.map(function(d){return d.type;}),
            datasets:[
              {label:'On Time',data:barData.map(function(d){return d.onTime;}),backgroundColor:'#10b981'},
              {label:'Breached',data:barData.map(function(d){return d.breached;}),backgroundColor:'#ef4444'}
            ]
          },
          options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}},plugins:{legend:{position:'bottom'}}}
        });
      }

      function renderSummary(barData){
        var body=qs('tableBody'); if(!body) return;
        body.innerHTML='';
        for(var i=0;i<barData.length;i++){
          var d=barData[i];
          var avg=d.total?(d.totalTime/d.total).toFixed(2):'0.00';
          var sla=d.total?((d.onTime/d.total)*100).toFixed(1):'0.0';
          var badgeClass='badge-green';
          if(Number(sla)<70) badgeClass='badge-red';
          else if(Number(sla)<90) badgeClass='badge-yellow';
          var thr=(thresholds[d.type]!==undefined)?thresholds[d.type]:'-';
          var tr=document.createElement('tr');
          tr.innerHTML=
            "<td><strong>"+esc(d.type)+"</strong></td>"+
            "<td style='text-align:center;'>"+thr+"</td>"+
            "<td style='text-align:center;'>"+d.total+"</td>"+
            "<td style='text-align:center;'><span class='badge badge-green'>"+d.onTime+"</span></td>"+
            "<td style='text-align:center;'><span class='badge badge-red'>"+d.breached+"</span></td>"+
            "<td style='text-align:center;'>"+avg+"</td>"+
            "<td style='text-align:center;'><span class='badge "+badgeClass+"'>"+sla+"%</span></td>";
          body.appendChild(tr);
        }
      }

      function renderTickets(){
        var tb=qs('ticketTbody'); if(!tb) return;
        var sb=qs('searchBox');
        var q=(sb?sb.value:'').toLowerCase().trim();
        tb.innerHTML='';
        for(var i=0;i<tickets.length;i++){
          var t=tickets[i]||{};
          var hay=(String(t.id)+' '+String(t.title)+' '+String(t.type)).toLowerCase();
          if(q && hay.indexOf(q)===-1) continue;
          var tr=document.createElement('tr');
          tr.className='border-b hover:bg-slate-50';
          tr.innerHTML=
            "<td class='py-2 pr-3 font-mono text-slate-700'>"+esc(t.id)+"</td>"+
            "<td class='py-2 pr-3 text-slate-800'>"+esc(t.title)+"</td>"+
            "<td class='py-2 pr-3 text-slate-700'>"+esc(t.type)+"</td>"+
            "<td class='py-2 pr-3 text-right text-slate-700'>"+Number(t.actualTime||0).toFixed(2)+"</td>"+
            "<td class='py-2 pr-3 text-right text-slate-700'>"+Number(t.threshold||0).toFixed(2)+"</td>";
          tb.appendChild(tr);
        }
      }

      function saveToWorkspace(){
        var d=dashId();
        if(!d || !window.StateApi) return Promise.resolve();
        var totals=computeTotals();
        var bau={totalTickets:totals.total,withinSLA:totals.onTime,breachedSLA:totals.breached,slaPercentage:totals.sla};
        return window.StateApi.merge(d,{run:{tickets:tickets,updatedAt:new Date().toISOString()},executive:{bauData:bau}});
      }

      function generateAndRender(){
        if(!tickets.length){toast('No tickets loaded','error');return;}
        var totals=computeTotals();
        var bar=buildBarData();
        renderKPIs(totals);
        renderCharts(totals,bar);
        renderSummary(bar);
        renderTickets();
      }

      function generateAndSave(){
        generateAndRender();
        if(!tickets.length) return;
        toast('Saving‚Ä¶','info');
        saveToWorkspace().then(function(){toast('Saved','ok');}).catch(function(){toast('Save failed','error');});
      }

      function downloadJpg(){
        var region=qs('captureRegion');
        if(!region){toast('Capture region not found','error');return;}
        toast('Generating image‚Ä¶','info');
        html2canvas(region,{backgroundColor:'#ffffff',scale:2})
          .then(function(canvas){
            var a=document.createElement('a');
            a.download='Run_Report_'+new Date().toISOString().slice(0,10)+'.jpg';
            a.href=canvas.toDataURL('image/jpeg',0.95);
            a.click();
            toast('Downloaded','ok');
          })
          .catch(function(){toast('Download failed','error');});
      }

      function openModal(){var m=qs('runModal'); if(!m) return; m.classList.remove('hidden'); m.classList.add('flex');}
      function closeModal(){var m=qs('runModal'); if(!m) return; m.classList.add('hidden'); m.classList.remove('flex');}
      function openAdoForm(){var a=qs('adoFormWrap'); if(a) a.classList.remove('hidden');}
      function closeAdoForm(){var a=qs('adoFormWrap'); if(a) a.classList.add('hidden');}

      function parseRows(rows){
        var out=[];
        for(var i=0;i<rows.length;i++){
          var r=rows[i]||{};
          var id=r.ID||r.Id||r.id||(''+Math.floor(Math.random()*1000000));
          var title=r.Title||r.title||'Untitled';
          var type=r['Ticket type']||r['Ticket Type']||r.Type||r.type||'Medium';
          var time=Number(r['Actual time']||r['Actual Time']||r.actualTime||0);
          var thr=Number(r.Threshold||r.threshold||thresholds[type]||6);
          out.push({id:String(id),title:String(title),type:String(type),actualTime:isFinite(time)?time:0,threshold:isFinite(thr)?thr:(thresholds[type]||6)});
        }
        return out;
      }

      function uploadFile(file){
        if(!file) return;
        toast('Reading file‚Ä¶','info');

        var lower=(file.name||'').toLowerCase();
        var isCsv=lower.endsWith('.csv');
        var reader=new FileReader();

        reader.onerror=function(){toast('File read failed','error');};

        reader.onload=function(e){
          try{
            var wb;
            if(isCsv){
              var text=e.target.result;
              wb=XLSX.read(text,{type:'string'});
            }else{
              var data=new Uint8Array(e.target.result);
              wb=XLSX.read(data,{type:'array'});
            }
            var sheet=wb.Sheets[wb.SheetNames[0]];
            var rows=XLSX.utils.sheet_to_json(sheet);
            tickets=parseRows(rows);

            var fp=qs('filePill'); if(fp) fp.textContent=file.name+' ('+tickets.length+' rows)';
            closeModal();
            generateAndSave();
          }catch(err){
            console.error(err);
            toast('Upload failed: '+(err.message||String(err)),'error');
          }
        };

        if(isCsv) reader.readAsText(file);
        else reader.readAsArrayBuffer(file);
      }

      async function adoSubmit(){
        toast('Querying ADO‚Ä¶','info');
        var org=(qs('adoOrg')&&qs('adoOrg').value||'').trim();
        var project=(qs('adoProject')&&qs('adoProject').value||'').trim();
        var queryId=(qs('adoQueryId')&&qs('adoQueryId').value||'').trim();
        var pat=(qs('adoPat')&&qs('adoPat').value||'').trim();
        if(!org||!project||!queryId||!pat){toast('Fill all ADO fields','error');return;}

        try{
          var resp=await fetch('/api/ado/run-tickets',{
            method:'POST',
            credentials:'same-origin',
            headers:{'Accept':'application/json','Content-Type':'application/json'},
            body:JSON.stringify({org:org,project:project,queryId:queryId,pat:pat})
          });
          var t=await resp.text();
          var j={}; try{j=JSON.parse(t||'{}');}catch(e){j={error:t};}
          if(!resp.ok) throw new Error(j.error||j.message||t||('HTTP '+resp.status));
          var list=j.tickets||[];
          if(!Array.isArray(list)||!list.length){toast('No tickets returned','error');return;}
          tickets=list;

          var fp=qs('filePill'); if(fp) fp.textContent='ADO Sync ('+tickets.length+' tickets)';
          closeAdoForm(); closeModal();
          generateAndSave();
        }catch(e){
          console.error(e);
          toast('ADO sync failed: '+(e.message||String(e)),'error');
        }
      }

      function loadFromWorkspace(){
        // IMPORTANT: load should render but not auto-save (prevents noisy writes)
        var d=dashId(); if(!d||!window.StateApi) return;
        window.StateApi.get(d).then(function(resp){
          var st=resp&&resp.state?resp.state:{};
          var run=st.run||{};
          if(Array.isArray(run.tickets)) tickets=run.tickets;
          if(tickets.length){
            var fp=qs('filePill'); if(fp) fp.textContent='Workspace ('+tickets.length+' tickets)';
            generateAndRender();
          }
        }).catch(function(){});
      }

      function init(){
        window.RunApp={
          saveNow:function(){return saveToWorkspace();},
          download:downloadJpg,
          openGenerate:openModal
        };
        window.addEventListener('tw:openGenerate', openModal);

        if(window.lucide && window.lucide.createIcons) window.lucide.createIcons();

        // modal wiring (safe)
        var c=qs('runModalClose'); if(c) c.addEventListener('click',closeModal);
        var cc=qs('runModalCancel'); if(cc) cc.addEventListener('click',closeModal);
        var up=qs('uploadPick'); if(up) up.addEventListener('click',function(){var fi=qs('fileInput'); if(fi) fi.click();});
        var ao=qs('adoOpenBtn'); if(ao) ao.addEventListener('click',openAdoForm);
        var ac=qs('adoCancel'); if(ac) ac.addEventListener('click',closeAdoForm);
        var as=qs('adoSubmit'); if(as) as.addEventListener('click',function(){adoSubmit();});
        var fi=qs('fileInput');
        if(fi) fi.addEventListener('change',function(e){var f=e.target.files&&e.target.files[0]; if(f) uploadFile(f); e.target.value='';});

        // tickets
        var sb=qs('searchBox'); if(sb) sb.addEventListener('input',renderTickets);
        var toggleBtn=qs('toggleTicketsBtn');
        if(toggleBtn) toggleBtn.addEventListener('click',function(){
          var sec=qs('ticketsSection'); if(!sec) return;
          sec.classList.toggle('hidden');
          toggleBtn.textContent=sec.classList.contains('hidden')?'Show Tickets':'Hide Tickets';
        });
        var ts=qs('ticketsSection'); if(ts) ts.classList.add('hidden');

        loadFromWorkspace();
      }

      window.addEventListener('DOMContentLoaded',init);
    })();
  </script>

  <!-- workspace.js (INLINE, with extra null-guards + dash pill update) -->
  <script>
    (function(){'use strict';
      function qs(id){return document.getElementById(id);}
      function dashId(){ try{ return new URL(location.href).searchParams.get('dash')||''; }catch(e){ return ''; } }
      function setDashInUrl(id){
        try{
          var u=new URL(location.href);
          if(id) u.searchParams.set('dash',id);
          else u.searchParams.delete('dash');
          location.href=u.pathname+u.search;
        }catch(e){
          location.href='/run.html?dash='+encodeURIComponent(id||'');
        }
      }

      function toast(msg, kind){
        var t=qs('toast'); if(!t) return;
        t.textContent=msg; t.classList.remove('hidden');
        t.classList.remove('bg-emerald-600','bg-red-600','bg-slate-900');
        t.classList.add(kind==='error'?'bg-red-600':(kind==='ok'?'bg-emerald-600':'bg-slate-900'));
        clearTimeout(toast._timer);
        toast._timer=setTimeout(function(){t.classList.add('hidden');}, 2600);
      }

      function fillSelect(sel, dashboards, current){
        if(!sel) return;
        sel.innerHTML = dashboards.map(function(d){
          var id=String(d.id);
          var name=(d.name||d.id);
          return '<option value="'+id.replace(/"/g,'&quot;')+'">'+String(name).replace(/</g,'&lt;')+'</option>';
        }).join('') || '<option value="">No workspaces</option>';
        sel.value = current || (dashboards[0] && dashboards[0].id) || '';
      }

      async function updateIndicator(id){
        var ind=qs('ws-indicator'); if(!ind) return;
        if(!id){ ind.textContent=''; return; }
        try{
          var resp=await window.StateApi.get(id);
          var meta=resp&&resp.meta?resp.meta:{};
          if(meta.published){
            ind.textContent = meta.publishedToAll ? 'Published (All)' : 'Published';
            ind.className='text-xs text-emerald-700 px-2 py-1 rounded-full bg-emerald-50 border border-emerald-200';
          }else{
            ind.textContent='Private';
            ind.className='text-xs text-slate-600 px-2 py-1 rounded-full bg-slate-50 border border-slate-200';
          }
        }catch(e){ ind.textContent=''; }
      }

      async function beforeSwitchSave(){
        try{ if(window.RunApp && typeof window.RunApp.saveNow==='function') await window.RunApp.saveNow(); }catch(e){}
      }

      async function switchWorkspace(id){
        if(!id) return;
        await beforeSwitchSave();
        setDashInUrl(id);
      }

      async function createWorkspace(){
        var name=prompt('New workspace name:');
        if(!name) return;
        var id='dash-'+Math.random().toString(36).slice(2,8)+'-'+Date.now().toString(36);
        var state={ __meta:{name:name}, executive:{ bauData:{} }, run:{ tickets:[] } };
        try{ await window.StateApi.save(id, state, name); toast('Workspace created','ok'); setDashInUrl(id); }
        catch(e){ toast('Create failed: '+(e.message||String(e)),'error'); }
      }

      async function renameWorkspace(){
        var id=dashId(); if(!id){ toast('Select workspace first','error'); return; }
        try{
          var resp=await window.StateApi.get(id);
          var current=resp&&resp.name?resp.name:id;
          var name=prompt('Rename workspace:', current);
          if(!name||name===current) return;
          var st=resp&&resp.state?resp.state:{};
          if(st && st.__meta) st.__meta.name=name;
          await window.StateApi.save(id, st, name);
          toast('Renamed','ok');
          location.reload();
        }catch(e){ toast('Rename failed: '+(e.message||String(e)),'error'); }
      }

      async function deleteWorkspace(){
        var id=dashId(); if(!id) return;
        if(!confirm('Delete workspace '+id+'?')) return;
        try{ await window.StateApi.remove(id); toast('Deleted','ok'); location.href='/run.html'; }
        catch(e){ toast('Delete failed: '+(e.message||String(e)),'error'); }
      }

      function downloadText(filename, text){
        var blob=new Blob([text],{type:'application/json'});
        var url=URL.createObjectURL(blob);
        var a=document.createElement('a');
        a.href=url; a.download=filename;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(function(){URL.revokeObjectURL(url);},1000);
      }

      async function exportWorkspace(){
        var id=dashId(); if(!id){ toast('Select workspace first','error'); return; }
        try{
          var resp=await window.StateApi.get(id);
          downloadText((resp.name||id)+'-workspace.json', JSON.stringify(resp,null,2));
          toast('Exported','ok');
        }catch(e){ toast('Export failed: '+(e.message||String(e)),'error'); }
      }

      async function importWorkspace(file){
        try{
          var text=await file.text();
          var data=JSON.parse(text);
          var id=data.id||('dash-'+Math.random().toString(36).slice(2,8));
          var name=data.name||id;
          var st=data.state||{};
          await window.StateApi.save(id, st, name);
          toast('Imported','ok');
          setDashInUrl(id);
        }catch(e){ toast('Import failed: '+(e.message||String(e)),'error'); }
      }

      async function openPublishModal(){
        var id=dashId(); if(!id){ toast('Select workspace first','error'); return; }
        var modal=qs('publishModal'), box=qs('publishUsers'), all=qs('publishAll');
        if(!modal || !box || !all){
          toast('Publish UI missing in HTML','error');
          return;
        }
        box.innerHTML='Loading‚Ä¶';
        all.checked=false;
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        try{
          var r=await fetch('/api/users/list',{credentials:'same-origin',headers:{'Accept':'application/json'}});
          var t=await r.text();
          var j={}; try{j=JSON.parse(t||'{}');}catch(e){j={};}
          var users=(j.users||[]).map(function(u){return u.userId;}).filter(Boolean);

          box.innerHTML = users.map(function(u){
            return '<label class="flex items-center justify-between px-2 py-1 border-b last:border-b-0">'+
              '<span class="font-mono text-xs">'+u+'</span>'+
              '<input type="checkbox" class="publishUser" value="'+u+'">'+
              '</label>';
          }).join('') || '<div class="text-xs text-slate-500">No users</div>';
        }catch(e){
          box.innerHTML='<div class="text-xs text-red-600">Failed to load users</div>';
        }
      }

      function closePublishModal(){
        var m=qs('publishModal');
        if(m){ m.classList.add('hidden'); m.classList.remove('flex'); }
      }

      async function doPublish(){
        var id=dashId();
        var all=qs('publishAll'); if(!all){toast('Publish UI missing','error');return;}
        var users=[];
        var checks=document.querySelectorAll('.publishUser');
        for(var i=0;i<checks.length;i++) if(checks[i].checked) users.push(checks[i].value);
        try{
          await window.StateApi.publish(id,{all:all.checked,users:users});
          toast('Published','ok');
          closePublishModal();
          updateIndicator(id);
        }catch(e){ toast('Publish failed: '+(e.message||String(e)),'error'); }
      }

      async function doUnpublish(){
        var id=dashId();
        try{ await window.StateApi.unpublish(id); toast('Unpublished','ok'); updateIndicator(id); }
        catch(e){ toast('Unpublish failed: '+(e.message||String(e)),'error'); }
      }

      function openGenerateReport(){
        if(window.RunApp && typeof window.RunApp.openGenerate==='function'){ window.RunApp.openGenerate(); return; }
        window.dispatchEvent(new CustomEvent('tw:openGenerate'));
      }

      function wireMenu(){
        var btn=qs('ws-actions-btn');
        var menu=qs('ws-actions-menu');
        var back=qs('ws-actions-backdrop');

        function open(){ if(menu) menu.classList.remove('hidden'); if(back) back.classList.remove('hidden'); }
        function close(){ if(menu) menu.classList.add('hidden'); if(back) back.classList.add('hidden'); }

        if(btn) btn.addEventListener('click', function(e){
          e.preventDefault(); e.stopPropagation();
          if(menu && menu.classList.contains('hidden')) open(); else close();
        });
        if(back) back.addEventListener('click', close);
        document.addEventListener('click', function(e){
          if(menu && !menu.classList.contains('hidden')){
            var inside=menu.contains(e.target) || (btn && btn.contains(e.target));
            if(!inside) close();
          }
        });

        if(menu) menu.addEventListener('click', function(e){
          var it = e.target.closest ? e.target.closest('[data-ws-action]') : null;
          if(!it) return;
          e.preventDefault();
          close();
          var act = it.getAttribute('data-ws-action');
          if(act==='generate') return openGenerateReport();
          if(act==='downloadJpg') { if(window.RunApp && window.RunApp.download) return window.RunApp.download(); return; }
          if(act==='new') return createWorkspace();
          if(act==='rename') return renameWorkspace();
          if(act==='save') { if(window.RunApp && window.RunApp.saveNow) return window.RunApp.saveNow(); return; }
          if(act==='export') return exportWorkspace();
          if(act==='import') { var f=qs('ws-import-file'); if(f) f.click(); return; }
          if(act==='publish') return openPublishModal();
          if(act==='unpublish') return doUnpublish();
          if(act==='delete') return deleteWorkspace();
        });
      }

      async function init(){
        if(!window.StateApi) return;

        // show current dash in pill
        var dp=qs('dashPill'); if(dp) dp.textContent = dashId() || '‚Äî';

        var sel=qs('ws-select');
        var current=dashId();
        try{
          var list = await window.StateApi.list();
          fillSelect(sel, list, current);

          var chosen=(sel && sel.value)?sel.value:current;
          if(!current && chosen){ setDashInUrl(chosen); return; }

          if(dp) dp.textContent = chosen || '‚Äî';
          updateIndicator(chosen);
        }catch(e){
          toast('Failed to load workspaces','error');
        }

        if(sel) sel.addEventListener('change', function(e){ switchWorkspace(e.target.value); });

        var imp=qs('ws-import-file');
        if(imp) imp.addEventListener('change', function(e){
          var f=e.target.files && e.target.files[0];
          if(f) importWorkspace(f);
          e.target.value='';
        });

        // publish modal wiring
        var pc=qs('publishClose'); if(pc) pc.addEventListener('click', closePublishModal);
        var pc2=qs('publishCancel'); if(pc2) pc2.addEventListener('click', closePublishModal);
        var pb=qs('publishDo'); if(pb) pb.addEventListener('click', doPublish);

        wireMenu();
      }

      window.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</head>

<body class="bg-white text-slate-900">
  <div id="toast" class="hidden fixed top-4 right-4 z-[9999] text-white text-sm px-4 py-3 rounded-xl shadow-lg bg-slate-900"></div>

  <!-- Header (same IDs and structure your JS expects) -->
  <div class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between gap-3">
      <div class="min-w-0">
        <div class="text-lg font-extrabold truncate">Run Dashboard</div>
        <div class="text-xs text-slate-500 truncate">
          Workspace: <span id="dashPill" class="font-mono">‚Äî</span> ‚Ä¢
          <span id="filePill">No data loaded</span>
        </div>
      </div>

      <div class="flex items-center gap-2 flex-wrap justify-end">
        <select id="ws-select" class="px-3 py-2 border border-slate-200 rounded-xl text-sm bg-white">
          <option value="">Loading‚Ä¶</option>
        </select>

        <span id="ws-indicator" class="text-xs text-slate-600 px-2 py-1 rounded-full bg-slate-50 border border-slate-200"></span>

        <div class="relative">
          <button id="ws-actions-btn" type="button"
                  class="px-3 py-2 text-sm bg-slate-100 text-slate-800 rounded-xl hover:bg-slate-200 flex items-center gap-2">
            Actions
          </button>
          <div id="ws-actions-backdrop" class="hidden fixed inset-0 z-40"></div>
          <div id="ws-actions-menu"
               class="hidden absolute right-0 mt-2 w-72 bg-white border border-slate-200 rounded-2xl shadow-xl overflow-hidden z-50">
            <div class="p-2">
              <button data-ws-action="generate" class="w-full text-left px-3 py-2 rounded-xl text-sm hover:bg-slate-50">Generate Report</button>
              <button data-ws-action="downloadJpg" class="w-full text-left px-3 py-2 rounded-xl text-sm hover:bg-slate-50">Download JPG</button>
              <div class="my-1 border-t"></div>
              <button data-ws-action="new" class="w-full text-left px-3 py-2 rounded-xl text-sm hover:bg-slate-50">Create New</button>
              <button data-ws-action="rename" class="w-full text-left px-3 py-2 rounded-xl text-sm hover:bg-slate-50">Rename</button>
              <button data-ws-action="save" class="w-full text-left px-3 py-2 rounded-xl text-sm hover:bg-slate-50">Save</button>
              <button data-ws-action="export" class="w-full text-left px-3 py-2 rounded-xl text-sm hover:bg-slate-50">Export</button>
              <button data-ws-action="import" class="w-full text-left px-3 py-2 rounded-xl text-sm hover:bg-slate-50">Import</button>
              <div class="my-1 border-t"></div>
              <button data-ws-action="publish" class="w-full text-left px-3 py-2 rounded-xl text-sm hover:bg-slate-50">Publish</button>
              <button data-ws-action="unpublish" class="w-full text-left px-3 py-2 rounded-xl text-sm hover:bg-slate-50">Unpublish</button>
              <div class="my-1 border-t"></div>
              <button data-ws-action="delete" class="w-full text-left px-3 py-2 rounded-xl text-sm hover:bg-red-50 text-red-700">Delete</button>
            </div>
          </div>
        </div>

        <input type="file" id="ws-import-file" accept="application/json" class="hidden" />

        <div class="relative">
          <button id="tw-menu-btn" class="w-10 h-10 rounded-xl bg-slate-900 text-white font-black flex items-center justify-center">‚ò∞</button>
          <div id="tw-menu" class="hidden absolute right-0 mt-2 w-80 bg-white text-slate-900 border border-slate-200 rounded-2xl shadow-xl overflow-hidden">
            <div class="px-4 py-3 border-b bg-slate-50">
              <div class="text-xs text-slate-500">Signed in as</div>
              <div id="tw-userpill" class="mt-1 text-sm font-semibold">Checking‚Ä¶</div>
            </div>
            <div class="p-2">
              <div class="px-2 pt-2 pb-1 text-[11px] font-semibold text-slate-500 uppercase tracking-wider">Navigation</div>
              <a id="nav-build" href="/build.html" class="block px-3 py-2 rounded-xl hover:bg-slate-50 text-sm">üõ†Ô∏è Build</a>
              <a id="nav-run" href="/run.html" class="block px-3 py-2 rounded-xl hover:bg-slate-50 text-sm">‚ñ∂Ô∏è Run</a>
              <a id="tw-execboard" href="/executive-board.html" class="hidden block px-3 py-2 rounded-xl hover:bg-slate-50 text-sm">üóÇÔ∏è Executive Board</a>
            </div>
            <div class="p-2 border-t">
              <div class="px-2 pt-2 pb-1 text-[11px] font-semibold text-slate-500 uppercase tracking-wider">Account</div>
              <a id="tw-usermgr" href="/user-manager.html" class="hidden block px-3 py-2 rounded-xl hover:bg-slate-50 text-sm">üë• User Manager</a>
              <button id="tw-logout" class="w-full text-left px-3 py-2 rounded-xl hover:bg-red-50 text-sm text-red-700">‚éã Logout</button>
            </div>
          </div>
        </div>

        <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" class="hidden"/>
      </div>
    </div>
  </div>

  <!-- Body -->
  <div class="max-w-7xl mx-auto px-4 py-6 space-y-6" id="captureRegion">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="rounded-2xl border border-slate-200 bg-white p-4">
        <div class="text-xs text-slate-500">Total Tickets</div>
        <div id="kpiTotal" class="mt-2 text-3xl font-extrabold">0</div>
      </div>
      <div class="rounded-2xl border border-emerald-200 bg-emerald-50 p-4">
        <div class="text-xs text-emerald-700">On Time</div>
        <div id="kpiOnTime" class="mt-2 text-3xl font-extrabold text-emerald-800">0</div>
      </div>
      <div class="rounded-2xl border border-red-200 bg-red-50 p-4">
        <div class="text-xs text-red-700">Breached</div>
        <div id="kpiBreached" class="mt-2 text-3xl font-extrabold text-red-800">0</div>
      </div>
      <div class="rounded-2xl border border-indigo-200 bg-indigo-50 p-4">
        <div class="text-xs text-indigo-700">SLA %</div>
        <div id="kpiSla" class="mt-2 text-3xl font-extrabold text-indigo-800">0.0%</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="rounded-2xl border border-slate-200 bg-white p-4">
        <div class="text-sm font-semibold mb-2">üìä SLA Overview</div>
        <div class="h-72"><canvas id="pieChart"></canvas></div>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-white p-4">
        <div class="text-sm font-semibold mb-2">üìà Ticket Types</div>
        <div class="h-72"><canvas id="barChart"></canvas></div>
      </div>
    </div>

    <div class="rounded-2xl border border-slate-200 bg-white p-4" id="summaryTableSection">
      <div class="flex items-center justify-between gap-3">
        <div class="text-sm font-semibold">üìã Ticket Type Summary</div>
        <button id="toggleTicketsBtn" type="button" class="text-xs px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 hover:bg-slate-100">Show Tickets</button>
      </div>
      <div class="mt-3 overflow-auto">
        <table id="summaryTable" class="min-w-full text-sm">
          <thead class="text-slate-600">
            <tr class="border-b">
              <th>Ticket Type</th>
              <th style="text-align:center;">Threshold (hrs)</th>
              <th style="text-align:center;">Total Count</th>
              <th style="text-align:center;">On Time</th>
              <th style="text-align:center;">Breached</th>
              <th style="text-align:center;">Avg Time (hrs)</th>
              <th style="text-align:center;">SLA %</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="ticketsSection" class="hidden">
      <div class="rounded-2xl border border-slate-200 bg-white p-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="text-sm font-semibold">Tickets</div>
          <input id="searchBox" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-sm outline-none" placeholder="Search by ID / Title / Type‚Ä¶"/>
        </div>
        <div class="mt-3 overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="text-slate-600">
              <tr class="border-b">
                <th class="py-2 pr-3 text-left">ID</th>
                <th class="py-2 pr-3 text-left">Title</th>
                <th class="py-2 pr-3 text-left">Type</th>
                <th class="py-2 pr-3 text-right">Hours</th>
                <th class="py-2 pr-3 text-right">Threshold</th>
              </tr>
            </thead>
            <tbody id="ticketTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Publish Modal (required by workspace features) -->
  <div id="publishModal" class="hidden fixed inset-0 z-[9999] bg-black/40 items-center justify-center p-4">
    <div class="w-full max-w-xl rounded-2xl bg-white border border-slate-200 shadow-xl p-5">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">Publish Workspace</div>
        <button id="publishClose" class="text-slate-500 hover:text-slate-900">‚úï</button>
      </div>
      <div class="mt-3 text-sm text-slate-600">
        <label class="flex items-center gap-2"><input type="checkbox" id="publishAll"> Publish to all users</label>
      </div>
      <div class="mt-3 rounded-xl border border-slate-200 max-h-56 overflow-auto" id="publishUsers"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="publishCancel" class="px-4 py-2 rounded-xl bg-slate-100 text-slate-800 text-sm">Cancel</button>
        <button id="publishDo" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold">Publish</button>
      </div>
    </div>
  </div>

  <!-- Generate Modal -->
  <div id="runModal" class="hidden fixed inset-0 z-[9999] bg-black/40 items-center justify-center p-4">
    <div class="w-full max-w-xl rounded-2xl bg-white border border-slate-200 shadow-xl p-5">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">Generate Report</div>
        <button id="runModalClose" class="text-slate-500 hover:text-slate-900">‚úï</button>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="rounded-xl border border-slate-200 p-3">
          <div class="text-xs font-semibold text-slate-600 uppercase tracking-wider">Upload Excel/CSV</div>
          <button id="uploadPick" class="mt-3 px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs font-semibold hover:bg-indigo-700">Choose File</button>
        </div>
        <div class="rounded-xl border border-slate-200 p-3">
          <div class="text-xs font-semibold text-slate-600 uppercase tracking-wider">Azure DevOps</div>
          <button id="adoOpenBtn" class="mt-3 px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-semibold hover:bg-slate-800">Open ADO Form</button>
        </div>
      </div>

      <div id="adoFormWrap" class="hidden mt-4 rounded-xl border border-slate-200 p-4">
        <div class="text-sm font-semibold">Azure DevOps Details</div>
        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
          <div>
            <label class="text-xs text-slate-600">Organization</label>
            <input id="adoOrg" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="BFLDevOpsOrg" />
          </div>
          <div>
            <label class="text-xs text-slate-600">Project</label>
            <input id="adoProject" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="3in1 Agile Board_MarTech" />
          </div>
          <div class="md:col-span-2">
            <label class="text-xs text-slate-600">Query ID</label>
            <input id="adoQueryId" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 font-mono text-[12px]" value="3a6725c4-6a00-43ff-ac2a-ed550c633088" />
          </div>
          <div class="md:col-span-2">
            <label class="text-xs text-slate-600">PAT Token</label>
            <input id="adoPat" type="password" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="PAT" />
          </div>
        </div>
        <div class="mt-3 flex justify-end gap-2">
          <button id="adoCancel" class="px-4 py-2 rounded-xl bg-slate-100 text-slate-800 text-sm">Cancel</button>
          <button id="adoSubmit" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold">Sync & Generate</button>
        </div>
      </div>

      <div class="mt-5 flex justify-end gap-2">
        <button id="runModalCancel" class="px-4 py-2 rounded-xl bg-slate-100 text-slate-800 text-sm">Close</button>
      </div>
    </div>
  </div>

  <!-- Menu toggle for the ‚ò∞ user menu -->
  <script>
    (function(){
      function toggle(el){ if(el) el.classList.toggle('hidden'); }
      window.addEventListener('DOMContentLoaded', function(){
        var hb=document.getElementById('tw-menu-btn');
        var hm=document.getElementById('tw-menu');
        if(hb) hb.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); toggle(hm); });
        document.addEventListener('click', function(e){
          if(hm && !hm.classList.contains('hidden') && !(hm.contains(e.target) || hb.contains(e.target))) hm.classList.add('hidden');
        });
      });
    })();
  </script>
</body>
</html>
