
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Run Dashboard</title>

  <script src="httpsndcss.com</script>
  https://unpkg.com/lucide@latest</script>
  https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js</script>
  https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datal/script>
  <script srcjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js</script>

  <style>
    /* keep capture clean */
    .no-capture { display: none !important; }
  </style>

  <script>
    // ---------- small helpers ----------
    function esc(s){
      return String(s || '').replace(/[&<>"']/g, function(c){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);
      });
    }
    function dashId(){
      try { return new URL(location.href).searchParams.get('dash') || ''; } catch(e){ return ''; }
    }
  </script>

  <script>
    // ---------- auth (same pattern as your other pages) ----------
    async function twJson(url, opt){
      opt = opt || {};
      const r = await fetch(url, {
        credentials:'same-origin',
        headers:{'Accept':'application/json','Content-Type':'application/json'},
        ...opt
      });
      const t = await r.text();
      let j={}; try{ j=JSON.parse(t||'{}'); }catch(e){ j={error:t}; }
      if(!r.ok) throw new Error(j.error||j.message||t||('HTTP '+r.status));
      return j;
    }
    async function twInit(){
      try{
        const me = await twJson('/api/auth/me');
        if(!me || !me.authenticated){
          const next=encodeURIComponent(location.pathname+location.search+location.hash);
          location.replace('/login.html?next='+next);
          return;
        }
        window.twMe = me;
        const pill=document.getElementById('tw-userpill');
        if(pill) pill.textContent=(me.userId||'User') + ' • ' + (me.role||'viewer');

        const eb=document.getElementById('tw-execboard');
        if(eb){
          const perms=me.permissions||{};
          eb.classList.toggle('hidden', !((me.role==='admin') || perms.executiveBoard));
        }
        const um=document.getElementById('tw-usermgr');
        if(um) um.classList.toggle('hidden', me.role!=='admin');

        const lo=document.getElementById('tw-logout');
        if(lo) lo.onclick = async ()=>{ try{ await twJson('/api/auth/logout',{method:'POST',body:'{}'}); }catch(e){} location.href='/login.html'; };
      }catch(e){
        const next=encodeURIComponent(location.pathname+location.search+location.hash);
        location.replace('/login.html?next='+next);
      }
    }
    window.addEventListener('DOMContentLoaded', ()=>twInit());
  </script>

  <script>
    // ---------- State API client (calls your /api/state.js) ----------
    function toQS(params){
      var escq = encodeURIComponent, parts=[];
      for(var k in params){
        if(!Object.prototype.hasOwnProperty.call(params,k)) continue;
        if(params[k]===undefined || params[k]===null) continue;
        parts.push(escq(k)+'='+escq(String(params[k])));
      }
      return parts.length ? ('?'+parts.join('&')) : '';
    }
    function safeJsonParse(t, fb){ try{ return JSON.parse(t||''); }catch(e){ return fb; } }

    function apiRequest(url, opt){
      opt = opt || {};
      var headers = opt.headers || {};
      headers['Accept'] = headers['Accept'] || 'application/json';
      if(opt.body!==undefined && opt.body!==null){
        headers['Content-Type'] = headers['Content-Type'] || 'application/json';
      }
      return fetch(url,{
        method: opt.method || 'GET',
        credentials:'same-origin',
        headers: headers,
        body: (opt.body!==undefined && opt.body!==null) ? JSON.stringify(opt.body) : undefined
      }).then(function(res){
        return res.text().then(function(t){
          var j = safeJsonParse(t, {error:t});
          if(!res.ok){
            var msg = (j && (j.error||j.message)) || t || ('HTTP '+res.status);
            var err = new Error(msg);
            err.status = res.status;
            err.payload = j;
            throw err;
          }
          return j;
        });
      });
    }

    var StateApi = {
      get: function(d){ return apiRequest('/api/state'+toQS({dash:d}), {method:'GET'}); },
      merge: function(d, patch){
        return apiRequest('/api/state'+toQS({dash:d, merge:1}), {method:'POST', body:{patch:patch}});
      }
    };
  </script>

  <script>
    // ---------- Run app logic ----------
    var tickets = [];
    var pieChart = null, barChart = null;
    var editIndex = -1;
    var thresholds = { Small:4, Medium:6, Large:8 };

    function qs(id){ return document.getElementById(id); }
    function setStatus(msg){ qs('statusText').textContent = msg; }
    function showError(msg){
      var box=qs('errorBox');
      box.textContent = msg;
      box.classList.remove('hidden');
    }
    function clearError(){
      var box=qs('errorBox');
      box.textContent = '';
      box.classList.add('hidden');
    }
    function setFilePill(msg){ qs('filePill').textContent = msg; }

    function computeKpis(list){
      var total=list.length, onTime=0;
      for(var i=0;i<list.length;i++){
        var t=list[i]||{};
        if(Number(t.actualTime) <= Number(t.threshold)) onTime++;
      }
      var breached = total - onTime;
      var sla = total ? ((onTime/total)*100).toFixed(1) : '0.0';
      return { total:total, onTime:onTime, breached:breached, sla:sla };
    }

    function groupByType(list){
      var map={};
      for(var i=0;i<list.length;i++){
        var t=list[i]||{};
        var tp = t.type || 'Medium';
        if(!map[tp]) map[tp]={total:0,onTime:0,breached:0};
        map[tp].total++;
        if(Number(t.actualTime) <= Number(t.threshold)) map[tp].onTime++;
        else map[tp].breached++;
      }
      return map;
    }

    function renderKpis(k){
      qs('kpiTotal').textContent = k.total;
      qs('kpiOnTime').textContent = k.onTime;
      qs('kpiBreached').textContent = k.breached;
      qs('kpiSla').textContent = k.sla + '%';
    }

    function renderCharts(k, byType){
      if(typeof ChartDataLabels !== 'undefined') Chart.register(ChartDataLabels);

      if(pieChart) pieChart.destroy();
      pieChart = new Chart(qs('pieChart').getContext('2d'), {
        type:'doughnut',
        data:{ labels:['On Time','Breached'], datasets:[{ data:[k.onTime,k.breached], backgroundColor:['#10b981','#ef4444'], borderWidth:0 }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom', labels:{ color:'#e2e8f0' } },
            datalabels:{ color:'#fff', font:{weight:'bold'}, formatter:function(v){return v;} }
          }
        }
      });

      if(barChart) barChart.destroy();
      var types = Object.keys(byType);
      var onArr=[], brArr=[];
      for(var i=0;i<types.length;i++){
        onArr.push(byType[types[i]].onTime);
        brArr.push(byType[types[i]].breached);
      }
      barChart = new Chart(qs('barChart').getContext('2d'), {
        type:'bar',
        data:{ labels:types, datasets:[
          { label:'On Time', data:onArr, backgroundColor:'#10b981' },
          { label:'Breached', data:brArr, backgroundColor:'#ef4444' }
        ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{
            x:{ stacked:true, ticks:{ color:'#e2e8f0' }, grid:{ color:'rgba(255,255,255,0.08)' } },
            y:{ stacked:true, ticks:{ color:'#e2e8f0' }, grid:{ color:'rgba(255,255,255,0.08)' }, beginAtZero:true }
          },
          plugins:{ legend:{ labels:{ color:'#e2e8f0' } } }
        }
      });
    }

    function statusLabel(t){
      return (Number(t.actualTime) <= Number(t.threshold)) ? 'On Time' : 'Breached';
    }

    function badge(txt){
      var ok = (txt==='On Time');
      var cls = ok ? 'bg-emerald-500/10 border-emerald-500/30 text-emerald-200' : 'bg-red-500/10 border-red-500/30 text-red-200';
      return "<span class='px-2 py-1 rounded-full border text-xs "+cls+"'>"+esc(txt)+"</span>";
    }

    function renderTable(){
      var q = (qs('searchBox').value||'').toLowerCase().trim();
      var tb = qs('ticketTbody');
      tb.innerHTML='';

      for(var i=0;i<tickets.length;i++){
        var t=tickets[i];
        var hay = (String(t.id)+' '+String(t.title)+' '+String(t.type)).toLowerCase();
        if(q && hay.indexOf(q)===-1) continue;

        var tr=document.createElement('tr');
        tr.className='border-b border-white/10 hover:bg-white/5';
        tr.innerHTML =
          "<td class='py-2 pr-3 font-mono'>"+esc(t.id)+"</td>"+
          "<td class='py-2 pr-3'>"+esc(t.title)+"</td>"+
          "<td class='py-2 pr-3'>"+esc(t.type)+"</td>"+
          "<td class='py-2 pr-3 text-right'>"+Number(t.actualTime||0).toFixed(2)+"</td>"+
          "<td class='py-2 pr-3 text-right'>"+Number(t.threshold||0).toFixed(2)+"</td>"+
          "<td class='py-2 pr-3'>"+badge(statusLabel(t))+"</td>"+
          "<td class='py-2 text-right'><button class='px-3 py-1 rounded-lg bg-indigo-500/20 border border-indigo-500/30 text-indigo-200 text-xs' data-edit='"+i+"'>Edit</button></td>";
        tb.appendChild(tr);
      }

      tb.querySelectorAll('[data-edit]').forEach(function(btn){
        btn.addEventListener('click', function(){
          openEdit(parseInt(btn.getAttribute('data-edit'),10));
        });
      });
    }

    function openEdit(i){
      editIndex=i;
      var t=tickets[i]||{};
      qs('editId').value = t.id || '';
      qs('editTitle').value = t.title || '';
      qs('editType').value = t.type || 'Medium';
      qs('editTime').value = (t.actualTime!=null)?t.actualTime:0;
      qs('editThreshold').value = (t.threshold!=null)?t.threshold:(thresholds[qs('editType').value]||6);

      qs('editModal').classList.remove('hidden');
      qs('editModal').classList.add('flex');
    }
    function closeEdit(){
      qs('editModal').classList.add('hidden');
      qs('editModal').classList.remove('flex');
    }
    function saveEdit(){
      if(editIndex<0) return;
      var t=tickets[editIndex]||{};
      t.id = qs('editId').value.trim();
      t.title = qs('editTitle').value.trim();
      t.type = qs('editType').value;
      t.actualTime = Number(qs('editTime').value||0);
      t.threshold = Number(qs('editThreshold').value||thresholds[t.type]||6);
      tickets[editIndex]=t;
      closeEdit();
      generate();
    }

    function parseRows(rows){
      var out=[];
      for(var i=0;i<rows.length;i++){
        var r=rows[i]||{};
        var id = r.ID || r.Id || r.id || (''+Math.floor(Math.random()*1000000));
        var title = r.Title || r.title || 'Untitled';
        var type = r['Ticket type'] || r.Type || r.type || 'Medium';
        var time = Number(r['Actual time'] || r['Actual Time'] || r.actualTime || 0);
        var thr = Number(r.Threshold || r.threshold || thresholds[type] || 6);
        out.push({ id:String(id), title:String(title), type:String(type), actualTime:time, threshold:thr });
      }
      return out;
    }

    function uploadFile(file){
      clearError();
      if(!file) return;
      setStatus('Reading file…');
      var reader=new FileReader();
      reader.onload=function(e){
        try{
          var data=new Uint8Array(e.target.result);
          var wb=XLSX.read(data,{type:'array'});
          var sheet=wb.Sheets[wb.SheetNames[0]];
          var rows=XLSX.utils.sheet_to_json(sheet);
          tickets = parseRows(rows);
          qs('filePill').textContent = 'File: '+file.name+' • '+tickets.length+' tickets';
          setStatus('File loaded. Click Generate Report.');
        }catch(err){
          showError('Upload failed: '+(err.message||String(err)));
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function syncAdo(){
      clearError();
      setStatus('Syncing from ADO…');
      var d=dashId();
      fetch('/api/ado/run-tickets?dash='+encodeURIComponent(d), { credentials:'same-origin', headers:{'Accept':'application/json'} })
        .then(function(r){
          return r.text().then(function(t){
            var j; try{ j=JSON.parse(t||'{}'); }catch(e){ j={error:t}; }
            if(!r.ok) throw new Error(j.error||j.message||t||('HTTP '+r.status));
            return j;
          });
        })
        .then(function(data){
          var list = (data && (data.tickets || data.items || data.payload || data)) || [];
          if(!Array.isArray(list) || !list.length) throw new Error('No tickets returned from ADO endpoint.');
          tickets = list;
          qs('filePill').textContent = 'ADO Sync • '+tickets.length+' tickets';
          setStatus('ADO data loaded. Click Generate Report.');
        })
        .catch(function(e){
          showError('ADO sync failed: '+(e.message||String(e)));
        });
    }

    function saveToWorkspace(){
      var d=dashId();
      if(!d) return;

      var k=computeKpis(tickets);
      var bauData={ totalTickets:k.total, withinSLA:k.onTime, breachedSLA:k.breached, slaPercentage:k.sla };

      // ✅ merge patch: updates only run + bauData; build data stays intact
      return StateApi.merge(d, {
        run: { tickets: tickets, updatedAt: new Date().toISOString() },
        executive: { bauData: bauData }
      });
    }

    function generate(){
      clearError();
      if(!tickets.length){
        showError('No tickets loaded. Use Actions → Upload Excel/CSV or Sync from ADO.');
        return;
      }
      var k=computeKpis(tickets);
      renderKpis(k);
      renderCharts(k, groupByType(tickets));
      renderTable();
      setStatus('Report generated and saved to workspace.');
      saveToWorkspace().catch(function(e){ /* non-fatal */ });
    }

    function downloadJpg(){
      clearError();
      setStatus('Generating image…');
      html2canvas(qs('captureRegion'), { backgroundColor:'#0f172a', scale:2 })
        .then(function(canvas){
          var a=document.createElement('a');
          a.download='Run_Report_'+new Date().toISOString().slice(0,10)+'.jpg';
          a.href=canvas.toDataURL('image/jpeg',0.95);
          a.click();
          setStatus('Downloaded.');
        })
        .catch(function(e){
          showError('Download failed: '+(e.message||String(e)));
        });
    }

    function loadFromWorkspace(){
      var d=dashId();
      qs('dashPill').textContent = d || '—';

      // keep nav links in same workspace
      try{
        var q = d ? ('?dash='+encodeURIComponent(d)) : '';
        qs('nav-build').href='/build.html'+q;
        qs('nav-run').href='/run.html'+q;
      }catch(e){}

      if(!d){
        setStatus('Missing ?dash=. Open Run from Build workspace.');
        return;
      }

      StateApi.get(d).then(function(resp){
        var st = (resp && resp.state) ? resp.state : {};
        var run = st.run || {};
        if(Array.isArray(run.tickets) && run.tickets.length){
          tickets = run.tickets;
          qs('filePill').textContent = 'Loaded from workspace • '+tickets.length+' tickets';
          setStatus('Loaded. Click Generate Report.');
        } else {
          setStatus('No Run data in this workspace yet.');
        }
      }).catch(function(e){
        setStatus('Could not load workspace state.');
      });
    }

    window.addEventListener('DOMContentLoaded', function(){
      lucide.createIcons();

      // menu toggles
      function toggle(id){
        var el=qs(id);
        if(el) el.classList.toggle('hidden');
      }
      qs('tw-menu-btn').onclick=function(e){ e.preventDefault(); toggle('tw-menu'); };
      qs('actionsBtn').onclick=function(e){ e.preventDefault(); toggle('actionsMenu'); };

      // actions click
      qs('actionsMenu').addEventListener('click', function(e){
        var el=e.target;
        while(el && el!==qs('actionsMenu') && !el.getAttribute('data-act')) el=el.parentNode;
        if(!el || !el.getAttribute) return;
        var act=el.getAttribute('data-act');
        qs('actionsMenu').classList.add('hidden');

        if(act==='upload') qs('fileInput').click();
        if(act==='ado') syncAdo();
        if(act==='generate') generate();
        if(act==='download') downloadJpg();
      });

      // file upload
      qs('fileInput').addEventListener('change', function(e){
        if(e.target.files && e.target.files[0]) uploadFile(e.target.files[0]);
      });

      // search
      qs('searchBox').addEventListener('input', renderTable);

      // edit modal
      qs('editClose').onclick=closeEdit;
      qs('editCancel').onclick=closeEdit;
      qs('editSave').onclick=saveEdit;
      qs('editType').addEventListener('change', function(){
        var tp=qs('editType').value;
        qs('editThreshold').value = thresholds[tp] || 6;
      });

     y-center p-4">
    <div class="w-full max-w-lg rounded-2xl bg-slate-900 border border-white/10 p-5">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">Edit Ticket</div>
        <button id="editClose" class="text-slate-300 hover:text-white">✕</button>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
        <div>
          <label class="text-xs text-slate-400">ID</label>
          <input id="editId" class="mt-1 w-full px-3 py-2 rounded-xl bg-slate-950 border border-white/10 outline-none"/>
        </div>
        <div>
          <label class="text-xs text-slate-400">Type</label>
          <select id="editType" class="mt-1 w-full px-3 py-2 rounded-xl bg-slate-950 border border-white/10 outline-none">
            <option>Small</option><option>Medium</option><option>Large</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="text-xs text-slate-400">Title</label>
          <input id="editTitle" class="mt-1 w-full px-3 py-2 rounded-xl bg-slate-950 border border-white/10 outline-none"/>
        </div>
        <div>
          <label class="text-xs text-slate-400">Actual Time (hrs)</label>
          <input id="editTime" type="number" step="0.01" class="mt-1 w-full px-3 py-2 rounded-xl bg-slate-950 border border-white/10 outline-none"/>
        </div>
        <div>
          <label class="text-xs text-slate-400">Threshold (hrs)</label>
          <input id="editThreshold" type="number" step="0.5" class="mt-1 w-full px-3 py-2 rounded-xl bg-slate-950 border border-white/10 outline-none"/>
        </div>
      </div>

      <div class="mt-5 flex justify-end gap-2">
        <button id="editCancel" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 text-sm">Cancel</button>
        <button id="editSave" class="px-4 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600 text-sm font-semibold">Save</button>
      </div>
    </div>
  </div>
</body>
</html>
