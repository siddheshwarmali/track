<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Executive Board</title>
  <!-- COPILOT_EXECBOARD_BUILDLIKE: 2026-01-23 16:44:44 IST | Card=Overall Summary, Details=Build-like Milestones + Discipline(L2) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body{font-family:'Inter',sans-serif;}
    .custom-scroll::-webkit-scrollbar{width:6px;height:6px}
    .custom-scroll::-webkit-scrollbar-track{background:#0b1220}
    .custom-scroll::-webkit-scrollbar-thumb{background:#334155;border-radius:999px}
    .line-clamp-4{display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden;}
  </style>
</head>
<body class="bg-slate-950 text-slate-100">

  <div class="sticky top-0 z-40 bg-slate-950/70 backdrop-blur border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 py-4 flex flex-wrap gap-3 items-center justify-between">
      <div class="min-w-0">
        <div class="text-lg font-extrabold">Executive Board</div>
        <div class="text-xs text-slate-400">All published dashboards you can access â€” card view</div>
      </div>

      <div class="flex flex-col sm:flex-row flex-wrap gap-2 items-stretch sm:items-center w-full sm:w-auto">
        <div class="flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm w-full sm:w-auto">
          <span class="text-slate-400 text-xs">Sort</span>
          <select id="sort" class="bg-transparent outline-none text-sm w-full sm:w-auto">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="name_asc">Name Aâ†’Z</option>
            <option value="name_desc">Name Zâ†’A</option>
          </select>
        </div>

        <div class="flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm w-full sm:w-auto">
          <span class="text-slate-400 text-xs">Search</span>
          <input id="q" placeholder="Project nameâ€¦" class="bg-transparent outline-none text-sm w-full sm:w-44" />
        </div>

        <a href="/index.html" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Back</a>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-4">
    <div id="status" class="text-sm text-slate-400">Loadingâ€¦</div>
    <pre id="err" class="hidden mt-3 p-3 rounded-xl border border-red-400/30 bg-red-400/10 text-red-200 text-xs whitespace-pre-wrap"></pre>
    <div id="grid" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const itemsById = new Map();

  function esc(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function fmt(iso){ try{ return new Date(iso).toLocaleString(); }catch{ return iso||'â€”'; } }
  function safeText(s, fb=''){ return (typeof s==='string' && s.trim()) ? s.trim() : fb; }

  function showErr(msg){ const e=$('err'); if(!e) return; e.textContent=String(msg||'Error'); e.classList.remove('hidden'); }
  function clearErr(){ const e=$('err'); if(!e) return; e.classList.add('hidden'); e.textContent=''; }

  async function jget(url){
    const r = await fetch(url, { headers:{'Accept':'application/json'}, credentials:'same-origin' });
    const t = await r.text();
    let j; try{ j = JSON.parse(t||'{}'); } catch(e){ throw new Error('Invalid JSON from '+url+' (HTTP '+r.status+'): '+t.slice(0,250)); }
    if(!r.ok) throw new Error(j.error || j.message || ('Request failed ('+r.status+')'));
    return j;
  }

  function sortItems(items, mode){
    const m=(mode||'newest');
    if(m==='oldest') return items.sort((a,b)=>(a.publishedAt||a.updatedAt||'').localeCompare(b.publishedAt||b.updatedAt||''));
    if(m==='name_asc') return items.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')));
    if(m==='name_desc') return items.sort((a,b)=>String(b.name||'').localeCompare(String(a.name||'')));
    return items.sort((a,b)=>(b.publishedAt||b.updatedAt||'').localeCompare(a.publishedAt||a.updatedAt||''));
  }

  function applySearch(){
    const q = ($('q')?.value||'').trim().toLowerCase();
    document.querySelectorAll('#grid [data-name]').forEach(el=>{
      const n = el.getAttribute('data-name')||'';
      el.style.display = (!q || n.includes(q)) ? '' : 'none';
    });
  }

  // ====== BUILD-LIKE SECTION 1: Overall Summary (CARD DEFAULT) ======
  function overallSummaryMarkup(summaryText){
    // Matches build look (purple box)
    return `
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-semibold text-gray-700 flex items-center">
          <span class="inline-flex w-5 h-5 mr-2 items-center justify-center text-purple-600">ðŸ“„</span>Overall Summary
        </h3>
      </div>
      <div class="bg-purple-50 p-4 rounded-lg border border-purple-100 text-gray-700 text-sm whitespace-pre-wrap">${esc(summaryText||'No summary')}</div>`;
  }

  // ====== BUILD-LIKE SECTION 2: Project Milestones - Application Tracker (DETAILS) ======
  function toDate(v){ try{ return v? new Date(v): null; }catch{ return null; } }
  function calcMilestoneColor(m){
    // Completed green, InProgress blue, YTB gray (as requested)
    const actualEnd = toDate(m.actualEndDate);
    const actualStart = toDate(m.actualStartDate);
    if(actualEnd) return 'bg-green-500';
    if(actualStart) return 'bg-blue-500';
    return 'bg-gray-400';
  }

  function renderMilestonesInto(containerId, state){
    const container = document.getElementById(containerId);
    if(!container) return;

    const milestonesRaw = Array.isArray(state?.executive?.milestones) ? state.executive.milestones : [];
    if(milestonesRaw.length === 0){
      container.innerHTML = `<div class="text-center py-10"><p class="text-gray-500 mt-2">Add Milestone</p></div>`;
      return;
    }

    const milestones = milestonesRaw.map(m => ({
      phase: safeText(m?.phase||m?.Activity||m?.title||m?.name||'Milestone'),
      startDate: safeText(m?.startDate||m?.plannedStart||m?.start||''),
      endDate: safeText(m?.endDate||m?.plannedEnd||m?.end||''),
      actualStartDate: safeText(m?.actualStartDate||m?.actualStart||''),
      actualEndDate: safeText(m?.actualEndDate||m?.actualEnd||'')
    }));

    const completedCount = milestones.filter(m => toDate(m.actualEndDate)).length;
    const pct = (completedCount / milestones.length) * 100;

    let html = `<div class="relative min-w-max px-4 pt-8 pb-4">`;
    html += `<div class="absolute top-12 left-4 right-4 h-1 bg-gray-300 z-0"></div>`;
    html += `<div class="absolute top-12 left-4 h-1 bg-blue-500 z-0 transition-all duration-500" style="width: ${pct}%"></div>`;
    html += `<div class="flex justify-between items-start">`;

    milestones.forEach((m) => {
      const color = calcMilestoneColor(m);
      html += `<div class="flex flex-col items-center z-10 relative mx-2" style="width: 120px">`;
      html += `<div class="w-8 h-8 rounded-full flex items-center justify-center mb-2 text-white shadow-sm ${color}">âœ“</div>`;
      html += `<p class="text-xs font-bold text-gray-700 text-center leading-tight mb-1 break-words w-full">${esc(m.phase)}</p>`;
      html += `</div>`;
    });

    html += `</div></div>`;
    container.innerHTML = html;
  }

  function buildMilestoneSectionHTML(dashId, state){
    const us = Array.isArray(state?.executive?.userStories) ? state.executive.userStories : [];
    const bugs = Array.isArray(state?.executive?.bugs) ? state.executive.bugs : [];
    const usOpen = us.filter(x=>String(x?.stage||x?.status||'').toLowerCase()!=='closed').length;
    const bugsOpen = bugs.filter(x=>String(x?.stage||x?.status||'').toLowerCase()!=='closed').length;

    const containerId = `milestone-container-${dashId}`;

    return `
      <div class="mb-8 border-b pb-8 border-gray-200">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold text-gray-700">Project Milestones - Application Tracker</h3>
        </div>
        <div class="text-sm text-slate-600 mb-3">User Stories: <b>${us.length}</b> (Open ${usOpen}) â€¢ Bugs: <b>${bugs.length}</b> (Open ${bugsOpen})</div>
        <div id="${containerId}" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-2 border-blue-200 p-6 overflow-x-auto min-h-[150px] custom-scroll"></div>
      </div>`;
  }

  // ====== BUILD-LIKE SECTION 3: Task Discipline Status L2 view (DETAILS) ======
  function buildDisciplineSectionHTML(dashId){
    const tbodyId = `discipline-tbody-${dashId}`;
    return `
      <div class="mb-2">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold text-gray-700 flex items-center">
            <span class="inline-flex w-5 h-5 mr-2 items-center justify-center text-teal-600">ðŸ“Š</span>Task Discipline Status
          </h3>
        </div>
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm mb-6 custom-scroll">
          <table class="min-w-full divide-y divide-gray-200" id="discipline-table-${dashId}">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Discipline</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Total</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Open</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Closed</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Hold</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Grand Total</th>
              </tr>
            </thead>
            <tbody id="${tbodyId}" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>`;
  }

  function renderDisciplineInto(dashId, state){
    const tbody = document.getElementById(`discipline-tbody-${dashId}`);
    if(!tbody) return;

    const taskDisciplines = Array.isArray(state?.executive?.taskDisciplines) ? state.executive.taskDisciplines : [];
    const l2Columns = Array.isArray(state?.executive?.l2Columns) ? state.executive.l2Columns : (Array.isArray(state?.l2Columns)?state.l2Columns:[]);
    const l2Data = (state?.executive?.l2Data && typeof state.executive.l2Data==='object') ? state.executive.l2Data : ((state?.l2Data && typeof state.l2Data==='object')?state.l2Data:{});

    const cols = (l2Columns && l2Columns.length) ? l2Columns : [{id:'c1',name:'Col 1'},{id:'c2',name:'Col 2'},{id:'c3',name:'Col 3'}];
    const colSpan = 1 + cols.length;

    let grand = {t:0,o:0,c:0,h:0,g:0};
    let rowsHtml = '';

    taskDisciplines.forEach(d=>{
      const disc = safeText(d.discipline,'');
      grand.t += +d.totalTasks; grand.o += +d.openTasks; grand.c += +d.closedTasks; grand.h += +d.holdTasks;
      const gtot = +(d.grandTotal ?? (d.openTasks + d.closedTasks + d.holdTasks));
      grand.g += gtot;

      const safeDisc = esc(disc);
      const key = encodeURIComponent(disc);

      rowsHtml += `
        <tr class="hover:bg-gray-50 text-sm transition-colors">
          <td class="px-6 py-4 font-medium cursor-pointer" data-l2-toggle="${key}">
            <span class="text-teal-700">${safeDisc}</span>
            <span class="ml-2 text-xs text-slate-400">(tap for L2)</span>
          </td>
          <td class="px-6 py-4 text-center text-blue-600 font-bold">${d.totalTasks||0}</td>
          <td class="px-6 py-4 text-center text-gray-600">${d.openTasks||0}</td>
          <td class="px-6 py-4 text-center text-gray-600">${d.closedTasks||0}</td>
          <td class="px-6 py-4 text-center text-gray-600">${d.holdTasks||0}</td>
          <td class="px-6 py-4 text-center font-bold">${gtot||0}</td>
        </tr>`;

      // L2 panel row
      const head = cols.map(c=>`<th class="px-3 py-2 text-center text-xs font-medium text-gray-500">${esc(c.name||c.id)}</th>`).join('');
      const l2rows = Array.isArray(l2Data && l2Data[disc]) ? l2Data[disc] : [];
      let l2Body='';
      if(l2rows.length===0){
        l2Body = `<tr><td colspan="${colSpan}" class="px-3 py-2 text-slate-500">No L2 items</td></tr>`;
      } else {
        l2rows.forEach(r=>{
          const feat = esc(r.feature || r.Feature || '');
          let cells='';
          cols.forEach(c=>{ cells += `<td class="px-3 py-2 text-center text-gray-700">${esc(r[c.id]||'')}</td>`; });
          l2Body += `<tr class="border-t"><td class="px-3 py-2 font-medium">${feat}</td>${cells}</tr>`;
        });
      }

      rowsHtml += `
        <tr class="hidden" data-l2-panel="${key}">
          <td colspan="6" class="px-6 pb-4">
            <div class="mt-2 rounded-lg border border-gray-200 bg-white overflow-x-auto custom-scroll">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Feature/Scope</th>${head}</tr></thead>
                <tbody>${l2Body}</tbody>
              </table>
            </div>
          </td>
        </tr>`;
    });

    rowsHtml += `<tr class="bg-gray-100 font-bold text-sm"><td class="px-6 py-4">Grand Total</td><td class="px-6 py-4 text-center">${grand.t}</td><td class="px-6 py-4 text-center">${grand.o}</td><td class="px-6 py-4 text-center">${grand.c}</td><td class="px-6 py-4 text-center">${grand.h}</td><td class="px-6 py-4 text-center">${grand.g}</td></tr>`;

    tbody.innerHTML = rowsHtml;
  }

  // ====== Card + Details container ======
  function card(item){
    const dashId = String(item.id||'');
    const safeDashId = encodeURIComponent(dashId);
    const name = esc(item.name||dashId||'Dashboard');
    const published = fmt(item.publishedAt||item.updatedAt);
    const owner = esc(item.ownerId||'');

    const detailsId = `details-${safeDashId.replace(/%/g,'_')}`;

    return `
      <div class='rounded-2xl border border-white/10 bg-white/5 overflow-hidden flex flex-col'>
        <div class='p-4 flex flex-col gap-3'>
          <div class='flex items-start justify-between gap-3'>
            <div class='min-w-0 flex-1'>
              <div class='text-base font-bold truncate' title='${name}'>${name}</div>
              <div class='mt-2 flex flex-wrap gap-2 text-xs text-slate-300'>
                <span class='px-2 py-1 rounded-full border border-indigo-400/30 bg-indigo-400/10'>Published: ${published}</span>
                <span class='px-2 py-1 rounded-full border border-white/10 bg-white/5'>Owner: ${owner}</span>
              </div>

              <!-- Card default: Overall Summary only -->
              <div class='mt-4 bg-white rounded-xl p-4'>
                ${overallSummaryMarkup(item.summary || 'No summary')}
              </div>
            </div>

            <div class='flex flex-wrap gap-2 justify-end shrink-0'>
              <a href='/index.html?dash=${safeDashId}' class='inline-flex px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm'>Open</a>
              <button type='button' data-toggle='${detailsId}' data-dash='${safeDashId}'
                class='inline-flex px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm'>Details</button>
            </div>
          </div>
        </div>

        <div id='${detailsId}' class='hidden p-4 space-y-6 border-t border-white/10 bg-white' data-loaded='0'>
          <div class='text-sm text-slate-600'>Loadingâ€¦</div>
        </div>
      </div>`;
  }

  // ====== Data loading (from your working approach) ======
  async function apiList(){ return jget('/api/state?list=1'); }
  async function apiGetDash(id){ return jget(`/api/state?dash=${encodeURIComponent(id)}`); }

  async function loadBoard(){
    clearErr();
    const status=$('status');
    if(status) status.textContent='Checking accessâ€¦';

    const me = await jget('/api/auth/me');
    if(!me.authenticated){ location.href='/login.html?next='+encodeURIComponent('/executive-board.html'); return; }

    const perms = me.permissions || {};
    if(!(me.role==='admin' || perms.executiveBoard)){
      showErr('Access denied: Executive Board access required.');
      if(status) status.textContent='â€”';
      return;
    }

    if(status) status.textContent='Loading dashboardsâ€¦';
    const sortMode = $('sort')?.value || 'newest';

    const listRes = await apiList();
    const dashboards = Array.isArray(listRes.dashboards) ? listRes.dashboards : [];
    const publishedFromList = dashboards.filter(d => d && (d.published === true || d.published === 1 || d.published === 'true'));
    const source = publishedFromList.length ? publishedFromList : dashboards;

    const pool = 4;
    let idx = 0;
    const items = [];

    async function worker(){
      while(idx < source.length){
        const i = idx++;
        const d = source[i];
        if(!d || !d.id) continue;
        try{
          const resp = await apiGetDash(d.id);
          const meta = resp.meta || {};
          const state = resp.state || {};
          if(publishedFromList.length === 0 && !meta.published) continue;

          const summary = safeText(state?.executive?.savedSummaryText || '', 'No summary');

          items.push({
            id: d.id,
            name: resp.name || d.name || d.id,
            ownerId: meta.ownerId || '',
            publishedAt: meta.publishedAt || d.publishedAt || d.updatedAt,
            updatedAt: d.updatedAt,
            summary,
            _state: state
          });
        }catch(e){}
      }
    }

    await Promise.all(Array.from({length: pool}, worker));
    sortItems(items, sortMode);

    itemsById.clear();
    items.forEach(it => { if(it && it.id) itemsById.set(String(it.id), it); });

    const grid=$('grid');
    if(grid){
      grid.innerHTML = items.length
        ? items.map(it => `<div data-name='${esc((it.name||'').toLowerCase())}'>${card(it)}</div>`).join('')
        : "<div class='text-slate-400 text-sm'>No published dashboards available.</div>";
    }

    if(status) status.textContent = `Showing ${items.length} published dashboard(s).`;
    applySearch();
  }

  function closeAllDetails(exceptId){
    document.querySelectorAll('#grid [id^="details-"]').forEach(p=>{
      if(exceptId && p.id===exceptId) return;
      p.classList.add('hidden');
      const btn = document.querySelector(`[data-toggle="${p.id}"]`);
      if(btn) btn.textContent='Details';
    });
  }

  function wireToggles(){
    const grid=$('grid');
    if(!grid || grid.__wired) return;
    grid.__wired = true;

    grid.addEventListener('click', (e)=>{
      // L2 toggles inside details
      const l2toggle = e.target.closest && e.target.closest('[data-l2-toggle]');
      if(l2toggle){
        const key = l2toggle.getAttribute('data-l2-toggle');
        const panel = grid.querySelector(`[data-l2-panel="${key}"]`);
        if(panel) panel.classList.toggle('hidden');
        return;
      }

      const btn = e.target.closest && e.target.closest('[data-toggle]');
      if(!btn) return;

      const detailsId = btn.getAttribute('data-toggle');
      const dashEnc = btn.getAttribute('data-dash');
      const dashId = dashEnc ? decodeURIComponent(dashEnc) : '';
      const panel = document.getElementById(detailsId);
      if(!panel) return;

      const willOpen = panel.classList.contains('hidden');
      closeAllDetails(detailsId);

      panel.classList.toggle('hidden');
      btn.textContent = panel.classList.contains('hidden') ? 'Details' : 'Hide';

      if(willOpen && panel.getAttribute('data-loaded') !== '1'){
        const item = itemsById.get(dashId);
        if(!item){
          panel.innerHTML = `<div class='text-sm text-slate-600'>No details available.</div>`;
          panel.setAttribute('data-loaded','1');
          return;
        }

        // Build-like sections 2 & 3 in details
        panel.innerHTML = buildMilestoneSectionHTML(encodeURIComponent(dashId), item._state)
                        + buildDisciplineSectionHTML(encodeURIComponent(dashId));

        // After inserting HTML, render actual content
        renderMilestonesInto(`milestone-container-${encodeURIComponent(dashId)}`, item._state);
        renderDisciplineInto(encodeURIComponent(dashId), item._state);

        panel.setAttribute('data-loaded','1');
      }
    });
  }

  function init(){
    const sortEl=$('sort');
    if(sortEl) sortEl.addEventListener('change', loadBoard);
    const qEl=$('q');
    if(qEl) qEl.addEventListener('input', applySearch);
    wireToggles();
    loadBoard().catch(err=>{ showErr(err.message||String(err)); const s=$('status'); if(s) s.textContent='â€”'; });
  }

  window.addEventListener('DOMContentLoaded', init);
})();
</script>

</body>
</html>
