<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Executive Board</title>
  <!-- COPILOT_EXECBOARD_REQUIREMENTS: 2026-01-23 16:27:30 IST | Card: Overall Summary (default). Details: Milestones+App Tracker + Task Discipline L2 (build-like). -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* fallback line-clamp */
    .line-clamp-4{display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden;}
    .custom-scroll::-webkit-scrollbar{width:6px;height:6px}
    .custom-scroll::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}
    .custom-scroll::-webkit-scrollbar-track{background:#f1f1f1}
  </style>
</head>
<body class="bg-slate-950 text-slate-100">

  <div class="sticky top-0 z-40 bg-slate-950/70 backdrop-blur border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 py-4 flex flex-wrap gap-3 items-center justify-between">
      <div class="min-w-0">
        <div class="text-lg font-extrabold">Executive Board</div>
        <div class="text-xs text-slate-400">All published dashboards you can access — card view</div>
      </div>

      <div class="flex flex-col sm:flex-row flex-wrap gap-2 items-stretch sm:items-center w-full sm:w-auto">
        <div class="flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm w-full sm:w-auto">
          <span class="text-slate-400 text-xs">Sort</span>
          <select id="sort" class="bg-transparent outline-none text-sm w-full sm:w-auto">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="name_asc">Name A→Z</option>
            <option value="name_desc">Name Z→A</option>
          </select>
        </div>

        <div class="flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm w-full sm:w-auto">
          <span class="text-slate-400 text-xs">Search</span>
          <input id="q" placeholder="Project name…" class="bg-transparent outline-none text-sm w-full sm:w-44" />
        </div>

        <a href="/index.html" class="px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm">Back</a>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-4">
    <div id="status" class="text-sm text-slate-400">Loading…</div>
    <pre id="err" class="hidden mt-3 p-3 rounded-xl border border-red-400/30 bg-red-400/10 text-red-200 text-xs whitespace-pre-wrap"></pre>
    <div id="grid" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const itemsById = new Map();

  // --- utilities ---
  function esc(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function fmt(iso){ try{ return new Date(iso).toLocaleString(); }catch{ return iso||'—'; } }
  function safeText(s, fb=''){ return (typeof s==='string' && s.trim()) ? s.trim() : fb; }

  function showErr(msg){ const e=$('err'); if(!e) return; e.textContent=String(msg||'Error'); e.classList.remove('hidden'); }
  function clearErr(){ const e=$('err'); if(!e) return; e.classList.add('hidden'); e.textContent=''; }

  async function jget(url){
    const r = await fetch(url, { headers:{'Accept':'application/json'}, credentials:'same-origin' });
    const t = await r.text();
    let j; try{ j = JSON.parse(t||'{}'); } catch(e){ throw new Error('Invalid JSON from '+url+' (HTTP '+r.status+'): '+t.slice(0,250)); }
    if(!r.ok) throw new Error(j.error || j.message || ('Request failed ('+r.status+')'));
    return j;
  }

  // --- sorting/search ---
  function sortItems(items, mode){
    const m=(mode||'newest');
    if(m==='oldest') return items.sort((a,b)=>(a.publishedAt||a.updatedAt||'').localeCompare(b.publishedAt||b.updatedAt||''));
    if(m==='name_asc') return items.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')));
    if(m==='name_desc') return items.sort((a,b)=>String(b.name||'').localeCompare(String(a.name||'')));
    return items.sort((a,b)=>(b.publishedAt||b.updatedAt||'').localeCompare(a.publishedAt||a.updatedAt||''));
  }
  function applySearch(){
    const q = ($('q')?.value||'').trim().toLowerCase();
    document.querySelectorAll('#grid [data-name]').forEach(el=>{
      const n = el.getAttribute('data-name')||'';
      el.style.display = (!q || n.includes(q)) ? '' : 'none';
    });
  }

  // --- Milestones: build-like journey (Completed green, InProgress blue, YTB gray) ---
  function toDate(v){ try{ return v? new Date(v): null; }catch{ return null; } }
  function milestoneStatus(m){
    const plannedEnd = toDate(m.endDate);
    const actualEnd = toDate(m.actualEndDate);
    const actualStart = toDate(m.actualStartDate);
    const today = new Date();

    if(actualEnd) return { status:'completed', color:'bg-green-500', label:'Completed' };
    if(actualStart){
      if(plannedEnd && today>plannedEnd) return { status:'delayed', color:'bg-red-500', label:'Delayed' };
      return { status:'inprogress', color:'bg-blue-500', label:'In Progress' };
    }
    if(plannedEnd && today>plannedEnd) return { status:'delayed', color:'bg-red-500', label:'Delayed' };
    return { status:'ytb', color:'bg-slate-400', label:'YTB' };
  }

  function renderMilestoneSection(item){
    const state=item._state || {};
    const milestones=Array.isArray(state?.executive?.milestones)?state.executive.milestones:[];
    const us=Array.isArray(state?.executive?.userStories)?state.executive.userStories:[];
    const bugs=Array.isArray(state?.executive?.bugs)?state.executive.bugs:[];
    const usOpen=us.filter(x=>String(x?.stage||x?.status||'').toLowerCase()!=='closed').length;
    const bugsOpen=bugs.filter(x=>String(x?.stage||x?.status||'').toLowerCase()!=='closed').length;

    const mapped=milestones.map(m=>({
      phase: safeText(m?.phase||m?.Activity||m?.title||m?.name||'Milestone'),
      startDate: safeText(m?.startDate||m?.plannedStart||m?.start||''),
      endDate: safeText(m?.endDate||m?.plannedEnd||m?.end||''),
      actualStartDate: safeText(m?.actualStartDate||m?.actualStart||''),
      actualEndDate: safeText(m?.actualEndDate||m?.actualEnd||'')
    }));

    if(mapped.length===0){
      return `
        <div class="mb-8 border-b pb-8 border-gray-200">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-700">Project Milestones - Application Tracker</h3>
          </div>
          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-2 border-blue-200 p-6">No milestones</div>
        </div>`;
    }

    const completedCount = mapped.filter(m=>milestoneStatus(m).status==='completed').length;
    const pct = (completedCount/mapped.length)*100;

    let nodes=`<div class="relative min-w-max px-4 pt-8 pb-4"><div class="absolute top-12 left-4 right-4 h-1 bg-gray-300 z-0"></div><div class="absolute top-12 left-4 h-1 bg-blue-500 z-0 transition-all duration-500" style="width:${pct}%"></div><div class="flex justify-between items-start">`;
    mapped.forEach((m)=>{
      const st=milestoneStatus(m);
      nodes += `<div class="flex flex-col items-center z-10 relative mx-2" style="width: 120px"><div class="w-8 h-8 rounded-full flex items-center justify-center mb-2 text-white shadow-sm ${st.color}">✓</div><p class="text-xs font-bold text-gray-700 text-center leading-tight mb-1 break-words w-full">${esc(m.phase)}</p></div>`;
    });
    nodes += `</div></div>`;

    return `
      <div class="mb-8 border-b pb-8 border-gray-200">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold text-gray-700 cursor-pointer hover:text-blue-600 select-none transition-colors" title="Project Milestones - Application Tracker">
            Project Milestones - Application Tracker
          </h3>
        </div>
        <div class="text-sm text-slate-200 mb-3">User Stories: <b>${us.length}</b> (Open ${usOpen}) • Bugs: <b>${bugs.length}</b> (Open ${bugsOpen})</div>
        <div id="milestone-container" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border-2 border-blue-200 p-6 overflow-x-auto min-h-[150px] custom-scroll">${nodes}</div>
      </div>`;
  }

  // --- Discipline: build-like L1 + inline L2 view ---
  function renderDisciplineSection(item){
    const state=item._state || {};
    const taskDisciplines=Array.isArray(state?.executive?.taskDisciplines)?state.executive.taskDisciplines:[];
    const l2Columns=Array.isArray(state?.executive?.l2Columns)?state.executive.l2Columns: (Array.isArray(state?.l2Columns)?state.l2Columns:[]);
    const l2Data=(state?.executive?.l2Data && typeof state.executive.l2Data==='object')?state.executive.l2Data: (state?.l2Data && typeof state.l2Data==='object'?state.l2Data:{});

    const cols = (l2Columns && l2Columns.length) ? l2Columns : [{id:'c1',name:'Col 1'},{id:'c2',name:'Col 2'},{id:'c3',name:'Col 3'}];

    // L1 rows
    let tbody = '';
    let grand = {t:0,o:0,c:0,h:0,g:0};
    (taskDisciplines||[]).forEach(d=>{
      grand.t += +d.totalTasks; grand.o += +d.openTasks; grand.c += +d.closedTasks; grand.h += +d.holdTasks; grand.g += +(d.grandTotal ?? (d.openTasks + d.closedTasks + d.holdTasks));
      tbody += `<tr class="hover:bg-gray-50 text-sm transition-colors">
        <td class="px-6 py-4 font-medium cursor-pointer" data-l2-toggle="${esc(d.discipline)}">${esc(d.discipline)}</td>
        <td class="px-6 py-4 text-center text-blue-600 font-bold">${d.totalTasks||0}</td>
        <td class="px-6 py-4 text-center text-gray-600">${d.openTasks||0}</td>
        <td class="px-6 py-4 text-center text-gray-600">${d.closedTasks||0}</td>
        <td class="px-6 py-4 text-center text-gray-600">${d.holdTasks||0}</td>
        <td class="px-6 py-4 text-center font-bold">${d.grandTotal ?? (d.openTasks + d.closedTasks + d.holdTasks) || 0}</td>
      </tr>`;
      // L2 container row
      tbody += `<tr class="hidden" data-l2-panel="${esc(d.discipline)}"><td colspan="6" class="px-6 pb-4">
        <div class="mt-2 rounded-lg border border-gray-200 bg-white overflow-x-auto custom-scroll">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50"><tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Feature/Scope</th>
              ${cols.map(c=>`<th class="px-3 py-2 text-center text-xs font-medium text-gray-500">${esc(c.name||c.id)}</th>`).join('')}
            </tr></thead>
            <tbody>
              ${(Array.isArray(l2Data?.[d.discipline])?l2Data[d.discipline]:[]).map(r=>{
                const feat = esc(r.feature||r.Feature||'');
                const cells = cols.map(c=>`<td class="px-3 py-2 text-center text-gray-700">${esc(r[c.id]||'')}</td>`).join('');
                return `<tr class="border-t"><td class="px-3 py-2 font-medium">${feat}</td>${cells}</tr>`;
              }).join('') || `<tr><td colspan="${1+len(cols)}" class="px-3 py-2 text-slate-500">No L2 items</td></tr>`}
            </tbody>
          </table>
        </div>
      </td></tr>`;
    });

    tbody += `<tr class="bg-gray-100 font-bold text-sm"><td class="px-6 py-4">Grand Total</td><td class="px-6 py-4 text-center">${grand.t}</td><td class="px-6 py-4 text-center">${grand.o}</td><td class="px-6 py-4 text-center">${grand.c}</td><td class="px-6 py-4 text-center">${grand.h}</td><td class="px-6 py-4 text-center">${grand.g}</td></tr>`;

    return `
      <div class="mb-8 border-b pb-8 border-gray-200">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold text-gray-700 flex items-center">Task Discipline Status</h3>
        </div>
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm mb-6 custom-scroll">
          <table class="min-w-full divide-y divide-gray-200" id="discipline-table">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Discipline</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Total</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Open</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Closed</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Hold</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Grand Total</th>
              </tr>
            </thead>
            <tbody id="discipline-tbody" class="bg-white divide-y divide-gray-200">${tbody}</tbody>
          </table>
        </div>
      </div>`;
  }

  function overallSummaryCard(summaryText){
    return `
      <div class="mb-3">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-xl font-semibold text-gray-700 flex items-center">Overall Summary</h3>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg border border-purple-100 text-gray-700 text-sm whitespace-pre-wrap">${esc(summaryText||'No summary')}</div>
      </div>`;
  }

  function card(item){
    const dashId = String(item.id||'');
    const name = esc(item.name||dashId||'Dashboard');
    const published = fmt(item.publishedAt||item.updatedAt);
    const owner = esc(item.ownerId||'');
    const summary = item.summary || 'No summary';
    const detailsId = `details-${encodeURIComponent(dashId).replace(/%/g,'_')}`;

    return `
      <div class='rounded-2xl border border-white/10 bg-white/5 overflow-hidden flex flex-col'>
        <div class='p-4 flex flex-col gap-3'>
          <div class='flex items-start justify-between gap-3'>
            <div class='min-w-0 flex-1'>
              <div class='text-base font-bold truncate' title='${name}'>${name}</div>
              <div class='mt-2 flex flex-wrap gap-2 text-xs text-slate-300'>
                <span class='px-2 py-1 rounded-full border border-indigo-400/30 bg-indigo-400/10'>Published: ${published}</span>
                <span class='px-2 py-1 rounded-full border border-white/10 bg-white/5'>Owner: ${owner}</span>
              </div>
              <!-- Card default view: Overall Summary -->
              <div class='mt-4 bg-white rounded-xl p-4'>
                ${overallSummaryCard(summary)}
              </div>
            </div>
            <div class='flex flex-wrap gap-2 justify-end shrink-0'>
              <a href='/index.html?dash=${encodeURIComponent(dashId)}' class='inline-flex px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm'>Open</a>
              <button type='button' data-toggle='${detailsId}' data-dash='${encodeURIComponent(dashId)}'
                class='inline-flex px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm'>Details</button>
            </div>
          </div>
        </div>
        <div id='${detailsId}' class='hidden p-4 space-y-6 border-t border-white/10 bg-white' data-loaded='0' data-dash='${encodeURIComponent(dashId)}'>
          <div class='text-sm text-slate-600'>Loading…</div>
        </div>
      </div>`;
  }

  async function apiList(){ return jget('/api/state?list=1'); }
  async function apiGetDash(id){ return jget(`/api/state?dash=${encodeURIComponent(id)}`); }

  async function loadBoard(){
    clearErr();
    const status=$('status');
    if(status) status.textContent='Checking access…';

    const me = await jget('/api/auth/me');
    if(!me.authenticated){ location.href='/login.html?next='+encodeURIComponent('/executive-board.html'); return; }

    const perms = me.permissions || {};
    if(!(me.role==='admin' || perms.executiveBoard)){
      showErr('Access denied: Executive Board access required.');
      if(status) status.textContent='—';
      return;
    }

    if(status) status.textContent='Loading dashboards…';

    const sortMode = $('sort')?.value || 'newest';
    const listRes = await apiList();
    const dashboards = Array.isArray(listRes.dashboards) ? listRes.dashboards : [];
    const publishedFromList = dashboards.filter(d => d && (d.published === true || d.published === 1 || d.published === 'true'));
    const source = publishedFromList.length ? publishedFromList : dashboards;

    const pool = 4;
    let idx = 0;
    const items = [];

    async function worker(){
      while(idx < source.length){
        const i = idx++;
        const d = source[i];
        if(!d || !d.id) continue;
        try{
          const resp = await apiGetDash(d.id);
          const meta = resp.meta || {};
          const state = resp.state || {};
          if(publishedFromList.length === 0 && !meta.published) continue;

          const saved = safeText(state?.executive?.savedSummaryText || '');
          const summary = saved || 'No summary';

          items.push({
            id: d.id,
            name: resp.name || d.name || d.id,
            ownerId: meta.ownerId || '',
            publishedAt: meta.publishedAt || d.publishedAt || d.updatedAt,
            updatedAt: d.updatedAt,
            summary,
            _state: state
          });
        }catch(e){}
      }
    }

    await Promise.all(Array.from({length: pool}, worker));
    sortItems(items, sortMode);

    itemsById.clear();
    items.forEach(it => { if(it && it.id) itemsById.set(String(it.id), it); });

    const grid=$('grid');
    if(grid){
      grid.innerHTML = items.length
        ? items.map(it => `<div data-name='${esc((it.name||'').toLowerCase())}'>${card(it)}</div>`).join('')
        : "<div class='text-slate-400 text-sm'>No published dashboards available.</div>";
    }

    if(status) status.textContent = `Showing ${items.length} published dashboard(s).`;
    applySearch();
  }

  function closeAllDetails(exceptId){
    document.querySelectorAll('#grid [id^="details-"]').forEach(p=>{
      if(exceptId && p.id===exceptId) return;
      p.classList.add('hidden');
      const btn = document.querySelector(`[data-toggle="${p.id}"]`);
      if(btn) btn.textContent='Details';
    });
  }

  function wireToggles(){
    const grid=$('grid');
    if(!grid || grid.__wired) return;
    grid.__wired = true;

    grid.addEventListener('click', (e)=>{
      const l2toggle = e.target.closest && e.target.closest('[data-l2-toggle]');
      if(l2toggle){
        const disc = l2toggle.getAttribute('data-l2-toggle');
        const panel = grid.querySelector(`[data-l2-panel="${CSS.escape(disc)}"]`);
        if(panel) panel.classList.toggle('hidden');
        return;
      }

      const btn = e.target.closest && e.target.closest('[data-toggle]');
      if(!btn) return;

      const id = btn.getAttribute('data-toggle');
      const dashEnc = btn.getAttribute('data-dash');
      const dashId = dashEnc ? decodeURIComponent(dashEnc) : '';
      const panel = document.getElementById(id);
      if(!panel) return;

      const willOpen = panel.classList.contains('hidden');
      closeAllDetails(id);

      panel.classList.toggle('hidden');
      btn.textContent = panel.classList.contains('hidden') ? 'Details' : 'Hide';

      if(willOpen && panel.getAttribute('data-loaded') !== '1'){
        const item = itemsById.get(dashId);
        panel.innerHTML = item
          ? (renderMilestoneSection(item) + renderDisciplineSection(item))
          : `<div class='text-sm text-slate-600'>No details available.</div>`;
        panel.setAttribute('data-loaded','1');
      }
    });
  }

  function init(){
    const sortEl=$('sort');
    if(sortEl) sortEl.addEventListener('change', loadBoard);
    const qEl=$('q');
    if(qEl) qEl.addEventListener('input', applySearch);
    wireToggles();
    loadBoard().catch(err=>{ showErr(err.message||String(err)); const s=$('status'); if(s) s.textContent='—'; });
  }

  window.addEventListener('DOMContentLoaded', init);
})();
</script>

</body>
</html>
