
<!DOCTYPE html><html lang='en'>
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Board</title>
<!-- COPILOT_EXECBOARD_MERGED_V2: 2026-01-23 14:46:46 IST | uses /api/state?list=1 (admin sees all) + debug counts -->

<!-- TW_BUILD_STAMP: 2026-01-16 15:28 IST (rename-db-fix) -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    
    <!-- html2canvas for Report Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .modal { display: none; }
        .modal.open { display: flex; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
        .hidden-by-report { display: none !important; }
        
        .clickable-cell:hover { text-decoration: underline; cursor: pointer; color: #2563eb; font-weight: 600; }
        [contenteditable] { padding: 4px 8px; border-radius: 4px; transition: all 0.2s; border: 1px solid transparent; }
        [contenteditable]:hover { background-color: #f8fafc; border-color: #e2e8f0; }
        [contenteditable]:focus { outline: none; background-color: #eff6ff; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .l3-row:hover { background-color: #f8fafc; }
        .l3-row:hover .delete-btn { opacity: 1; pointer-events: auto; }
        .delete-btn { opacity: 0; transition: opacity 0.2s; }
    

/* === Advanced Mobile Tracker UX (progressive disclosure + bottom sheet) === */
.ax-card{background:#eff6ff;border:1px solid #bfdbfe;border-radius:16px;padding:14px;color:#0f172a;}
.ax-head{display:flex;flex-direction:column;gap:10px;margin-bottom:12px;}
.ax-title{font-weight:900;font-size:16px;line-height:1.2;color:#0f172a;}
.ax-kpis{display:flex;flex-wrap:wrap;gap:8px;}
.ax-kpi{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:11px;font-weight:900;border:1px solid rgba(15,23,42,0.10);background:rgba(255,255,255,0.75);}
.ax-kpi.good{background:#dcfce7;border-color:#bbf7d0;color:#166534;}
.ax-kpi.bad{background:#fee2e2;border-color:#fecaca;color:#991b1b;}
.ax-kpi.neu{background:#dbeafe;border-color:#bfdbfe;color:#1d4ed8;}
.ax-kpi.gray{background:#f1f5f9;border-color:#e2e8f0;color:#475569;}

.ax-tabs{display:flex;gap:8px;}
.ax-tab{flex:1;display:flex;align-items:center;justify-content:center;padding:10px 10px;border-radius:14px;font-size:12px;font-weight:900;border:1px solid rgba(15,23,42,0.10);background:rgba(255,255,255,0.8);color:#0f172a;}
.ax-tab.active{background:#1d4ed8;border-color:#1d4ed8;color:#fff;}

.ax-scroll{overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;padding-bottom:8px;}
.ax-scroll::-webkit-scrollbar{height:8px;}
.ax-scroll::-webkit-scrollbar-track{background:rgba(15,23,42,0.08);border-radius:999px;}
.ax-scroll::-webkit-scrollbar-thumb{background:rgba(59,130,246,0.45);border-radius:999px;}
.ax-scroll::-webkit-scrollbar-thumb:hover{background:rgba(59,130,246,0.65);}

/* Timeline */
.ax-track{--dot:28px;--n:7;position:relative;min-width:max(100%, calc(var(--n) * 132px));padding:16px 6px 10px 6px;border-radius:14px;border:1px solid rgba(29,78,216,0.18);background:rgba(219,234,254,0.38);} 
.ax-line{position:absolute;left:calc(var(--dot)/2);right:calc(var(--dot)/2);top:32px;height:6px;background:#d1d5db;border-radius:999px;}
.ax-linefill{position:absolute;left:calc(var(--dot)/2);top:32px;height:6px;background:#3b82f6;border-radius:999px;}
.ax-items{display:flex;justify-content:space-between;gap:14px;position:relative;}
.ax-item{flex:0 0 132px;display:flex;flex-direction:column;align-items:center;text-align:center;}
.ax-dot{width:var(--dot);height:var(--dot);border-radius:999px;display:grid;place-items:center;color:#fff;box-shadow:0 4px 10px rgba(15,23,42,0.18);} 
.ax-dot.completed{background:#22c55e;}
.ax-dot.ongoing{background:#3b82f6;}
.ax-dot.pending{background:#9ca3af;}
.ax-dot svg{width:14px;height:14px;}
.ax-label{margin-top:8px;font-size:12px;font-weight:900;color:#0f172a;line-height:1.15;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}

/* List */
.ax-controls{display:flex;gap:10px;align-items:center;margin:10px 0 10px 0;flex-wrap:wrap;}
.ax-search{flex:1;min-width:160px;display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;border:1px solid rgba(15,23,42,0.12);background:rgba(255,255,255,0.85);} 
.ax-search input{border:none;outline:none;background:transparent;width:100%;font-size:12px;font-weight:700;color:#0f172a;}
.ax-filters{display:flex;gap:6px;flex-wrap:wrap;}
.ax-filter{padding:8px 10px;border-radius:999px;border:1px solid rgba(15,23,42,0.10);background:rgba(255,255,255,0.8);font-size:11px;font-weight:900;color:#0f172a;}
.ax-filter.active{background:#0f172a;color:#fff;border-color:#0f172a;}

.ax-list{display:flex;flex-direction:column;gap:10px;}
.ax-row{background:rgba(255,255,255,0.92);border:1px solid rgba(15,23,42,0.10);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:10px;}
.ax-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
.ax-name{font-size:13px;font-weight:900;line-height:1.15;color:#0f172a;}
.ax-sub{font-size:11px;color:#475569;font-weight:700;margin-top:4px;}
.ax-pills{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;}
.ax-pill{display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;border-radius:999px;font-size:10px;font-weight:900;border:1px solid transparent;white-space:nowrap;}
.ax-pill.completed{background:#dcfce7;color:#166534;border-color:#bbf7d0;}
.ax-pill.ongoing{background:#dbeafe;color:#1d4ed8;border-color:#bfdbfe;}
.ax-pill.pending{background:#f1f5f9;color:#475569;border-color:#e2e8f0;}
.ax-pill.ontrack{background:#dcfce7;color:#166534;border-color:#bbf7d0;}
.ax-pill.delayed{background:#fee2e2;color:#991b1b;border-color:#fecaca;}
.ax-pill.unknown{background:#f1f5f9;color:#475569;border-color:#e2e8f0;}

.ax-actions{display:flex;gap:10px;}
.ax-btn{flex:1;display:flex;align-items:center;justify-content:center;padding:10px 10px;border-radius:14px;border:1px solid rgba(15,23,42,0.10);background:#ffffff;font-size:12px;font-weight:900;color:#0f172a;}
.ax-btn.primary{background:#1d4ed8;color:#fff;border-color:#1d4ed8;}

/* Bottom sheet */
.ax-overlay{position:fixed;inset:0;background:rgba(2,6,23,0.55);display:none;z-index:60;}
.ax-overlay.open{display:block;}
.ax-sheet{position:fixed;left:0;right:0;bottom:0;background:#ffffff;border-radius:18px 18px 0 0;transform:translateY(110%);transition:transform 220ms ease;z-index:61;max-height:86vh;overflow:auto;}
.ax-sheet.open{transform:translateY(0);}
.ax-sheethead{padding:12px 14px;border-bottom:1px solid #e5e7eb;display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
.ax-sheettitle{font-size:14px;font-weight:900;color:#0f172a;line-height:1.2;}
.ax-close{border:none;background:#f1f5f9;color:#0f172a;border-radius:12px;padding:8px 10px;font-size:12px;font-weight:900;}
.ax-sheetbody{padding:14px;}
.ax-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.ax-box{border-radius:14px;padding:12px;border:1px solid rgba(15,23,42,0.08);}
.ax-box h6{font-size:10px;font-weight:900;letter-spacing:0.25px;text-transform:uppercase;margin:0 0 6px 0;}
.ax-box p{margin:0;font-size:12px;line-height:1.35;color:#334155;font-weight:700;}
.ax-box.planned{background:#eff6ff;} .ax-box.planned h6{color:#1d4ed8;}
.ax-box.actual{background:#ecfdf5;} .ax-box.actual h6{color:#047857;}
.ax-box.owner{background:#fffbeb;} .ax-box.owner h6{color:#b45309;}
.ax-note{margin-top:12px;color:#475569;font-size:12px;line-height:1.4;font-weight:700;}

@media (max-width: 480px){
  .ax-grid{grid-template-columns:1fr;}
  .ax-item{flex-basis:120px;}
  .ax-track{min-width:max(100%, calc(var(--n) * 120px));}
}
</style>

    <style>
      @keyframes ghspin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
      /* Hide Clear Storage button */
      button[onclick^="wsClearLocalStorage"], button[onclick="wsClearLocalStorage()"] { display:none !important; }
    </style>

<script>
  async function twJson(url, opt){
    const r = await fetch(url, Object.assign({headers:{'Accept':'application/json','Content-Type':'application/json'}}, opt||{}));
    const t = await r.text();
    let j={};
    try{ j=JSON.parse(t||'{}'); }catch{ j={error:t}; }
    if(!r.ok) throw new Error(j.error||j.message||t||('HTTP '+r.status));
    return j;
  }

  async function twInit(){
    const pill=document.getElementById('tw-userpill');
    const mgr=document.getElementById('tw-usermgr');
    const lo=document.getElementById('tw-logout');
    try{
      const me = await twJson('/api/auth/me');
      if(!me || !me.authenticated){
        const next=encodeURIComponent(location.pathname+location.search+location.hash);
        location.replace('/login.html?next='+next);
        return;
      }
      const role = me.role || 'viewer';
      document.body.classList.remove('role-admin','role-creator','role-viewer');
      document.body.classList.add('role-'+role);
      if(pill) pill.textContent = (me.userId||'User') + ' • ' + role;
      if(mgr) mgr.classList.toggle('hidden', role!=='admin');
      if(lo) lo.onclick = async ()=>{ try{ await twJson('/api/auth/logout', {method:'POST'});}catch(e){} location.href='/login.html'; };
    }catch(e){
      const next=encodeURIComponent(location.pathname+location.search+location.hash);
      location.replace('/login.html?next='+next);
    }
  }
  window.addEventListener('DOMContentLoaded', ()=>{ twInit(); });
</script>

</head>
<body class='bg-slate-950 text-slate-100'>
  <div class='sticky top-0 z-40 bg-slate-950/70 backdrop-blur border-b border-white/10'>
    <div class='max-w-6xl mx-auto px-4 py-4 flex flex-wrap gap-3 items-center justify-between'>
      <div>
        <div class='text-lg font-extrabold'>Executive Board</div>
        <div class='text-xs text-slate-400'>All published dashboards you can access — card view • Advanced Mobile UX • Build 2026-01-26 17:08 IST</div>
      </div>
      <div class='flex flex-col sm:flex-row flex-wrap gap-2 items-stretch sm:items-center w-full sm:w-auto'>
        <div class='flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm w-full sm:w-auto'>
          <span class='text-slate-400 text-xs'>Sort</span>
          <select id='sort' class='bg-transparent outline-none text-sm'>
            <option value='newest'>Newest</option>
            <option value='oldest'>Oldest</option>
            <option value='name_asc'>Name A→Z</option>
            <option value='name_desc'>Name Z→A</option>
          </select>
        </div>
        <div class='flex items-center gap-2 rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm w-full sm:w-auto'>
          <span class='text-slate-400 text-xs'>Search</span>
          <input id='q' placeholder='Project name…' class='bg-transparent outline-none text-sm w-full sm:w-44' />
        </div>
        <a href='/index.html' class='px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm'>Back</a>
      </div>
    </div>
  </div>

  <div class='max-w-6xl mx-auto px-4 py-4'>
    <div id='status' class='text-sm text-slate-400'>Loading…</div>
    <div id='err' class='hidden mt-3 p-3 rounded-xl border border-red-400/30 bg-red-400/10 text-red-200 text-sm'></div>
    <div id='grid' class='mt-4 grid grid-cols-1 md:grid-cols-2 gap-4'></div>
  </div>

<script>
async function jget(url){
  const r = await fetch(url, { headers:{'Accept':'application/json'} });
  const t = await r.text();
  let j={}; try{ j=JSON.parse(t||'{}'); }catch{ j={}; }
  if(!r.ok) throw new Error(j.error || `Request failed (${r.status})`);
  return j;
}
function fmt(iso){ try{ return new Date(iso).toLocaleString(); }catch{ return iso||'—'; } }
function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function card(d){
  const dashId = String(d.id || '');
  const name = esc(d.name || d.id || 'Dashboard');
  const published = fmt(d.publishedAt || d.updatedAt);
  const owner = esc(d.ownerId || '');
  // NOTE: /api/board may not include summary. We hydrate it from /api/state in hydrateCardSummaries().
  const summary = esc(d.summary || '');
  const detailsId = `details-${encodeURIComponent(dashId || name).replace(/%/g,'_')}`;

  return `
  <div class='rounded-2xl border border-white/10 bg-white/5 overflow-hidden flex flex-col'>
    <div class='p-4 flex flex-col gap-3'>
      <div class='flex items-start justify-between gap-3'>
        <div class='min-w-0'>
          <div class='text-base font-bold truncate' title='${name}'>${name}</div>
          <div class='mt-2 flex flex-wrap gap-2 text-xs text-slate-300'>
            <span class='px-2 py-1 rounded-full border border-indigo-400/30 bg-indigo-400/10'>Published: ${published}</span>
            <span class='px-2 py-1 rounded-full border border-white/10 bg-white/5'>Owner: ${owner}</span>
          </div>
          <!-- Only Overall Summary visible on the card -->
          <div class='mt-3 text-sm text-slate-200 leading-relaxed line-clamp-4 whitespace-pre-wrap' data-card-summary='${encodeURIComponent(dashId)}'>${summary || '—'}</div>
        </div>
        <div class='flex flex-wrap gap-2 justify-end shrink-0'>
          <a href='/index.html?dash=${encodeURIComponent(dashId)}' class='inline-flex px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm'>Open</a>
          <button type='button' data-toggle='${detailsId}' data-dash='${encodeURIComponent(dashId)}'
            class='inline-flex px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm'>Details</button>
        </div>
      </div>
    </div>

    <!-- Other details load only after clicking Details -->
    <div id='${detailsId}' class='hidden p-4 space-y-3 border-t border-white/10' data-loaded='0' data-dash='${encodeURIComponent(dashId)}'>
      <div class='text-sm text-slate-300'>Loading…</div>
    </div>
  </div>`;
}

function applySearch(){
  const q = (document.getElementById('q').value||'').trim().toLowerCase();
  document.querySelectorAll('#grid [data-name]').forEach(el=>{
    const n = el.getAttribute('data-name')||'';
    el.style.display = (!q || n.includes(q)) ? '' : 'none';
  });
}

async function load(){
  const status=document.getElementById('status');
  const err=document.getElementById('err');
  err.classList.add('hidden');
  status.textContent='Checking access…';
  const me = await jget('/api/auth/me');
  if(!me.authenticated){ location.href='/login.html?next='+encodeURIComponent('/executive-board.html'); return; }
  const perms = me.permissions || {};
  if(!(me.role==='admin' || perms.executiveBoard)){
    err.textContent='Access denied: Admin has not granted Executive Board access.';
    err.classList.remove('hidden');
    status.textContent='—';
    return;
  }
  status.textContent='Loading…';
  const sort=document.getElementById('sort').value;
  const data = await jget('/api/board?sort='+encodeURIComponent(sort));
  const items = Array.isArray(data.items)?data.items:[];
  const grid=document.getElementById('grid');
  grid.innerHTML = items.map(d=>`<div data-name='${esc((d.name||'').toLowerCase())}'>${card(d)}</div>`).join('') || "<div class='text-slate-400 text-sm'>No published dashboards available.</div>";
  hydrateCardSummaries(items);
  status.textContent = `Showing ${items.length} published dashboard(s).`;
  applySearch();
}

document.getElementById('sort').addEventListener('change', load);
document.getElementById('q').addEventListener('input', applySearch);


// ===== Details preview rendering =====
// We hydrate card summary and details from /api/state?dash=<id> (same endpoint used by the main dashboard workspace manager). citeturn8search25
async function fetchDashState(dashId){
  const r = await fetch(`/api/state?dash=${encodeURIComponent(dashId)}`, {
    headers: { 'Accept':'application/json' },
    credentials: 'same-origin'
  });
  const t = await r.text();
  let j = {};
  try{ j = JSON.parse(t || '{}'); }catch{ j = { error: t }; }
  if(!r.ok) throw new Error(j.error || j.message || `HTTP ${r.status}`);
  // Some backends return {state:"{...}"} (string). Normalize to an object.
  let st = j.state || (j.data && j.data.state) || j;
  if(typeof st === 'string'){
    try{ st = JSON.parse(st); }catch{ /* keep as string */ }
  }
  return st;
}

async function hydrateCardSummaries(items){
  try{
    const list = Array.isArray(items) ? items : [];
    const limit = Math.min(list.length, 30); // safety cap
    const pool = 3;
    let idx = 0;
    async function worker(){
      while(idx < limit){
        const i = idx++;
        const it = list[i];
        const dashId = String(it && it.id || '');
        if(!dashId) continue;
        const el = document.querySelector('[data-card-summary="' + encodeURIComponent(dashId) + '"]');
        if(!el) continue;
        const cur = (el.textContent || '').trim();
        if(cur && cur !== '—' && cur !== 'No summary') continue;
        try{
          const st = await fetchDashState(dashId);
          const exec = (st && (st.executive || st.exec || st)) || {};
          const sum = (exec.savedSummaryText || exec.summary || '').toString().trim();
          if(sum) el.textContent = sum;
        }catch(e){}
      }
    }
    await Promise.all(Array.from({length: pool}, worker));
  }catch(e){}
}

function countOpen(items){
  return (items||[]).filter(it => {
    const s = String(it && (it.stage || it.status) || '').toLowerCase();
    return s && !s.includes('closed');
  }).length;
}



function axToDate(v){ try{ return v? new Date(v): null; }catch(e){ return null; } }
function axFmt(v){
  if(!v) return '-';
  const d = axToDate(v);
  if(d && !isNaN(+d)) return d.toISOString().slice(0,10);
  return String(v);
}
function axLabel(x){
  let s = String(x||'').trim();
  s = s.split('_').join(' ');
  s = s.split('-').join(' ');
  let out='';
  for(let i=0;i<s.length;i++){
    const ch=s[i];
    const prev=i>0?s[i-1]:'';
    const isUpper = ch>='A' && ch<='Z';
    const wasLower = prev>='a' && prev<='z';
    if(i>0 && isUpper && wasLower) out += ' ';
    out += ch;
  }
  s=out;
  while(s.indexOf('  ')!==-1) s = s.split('  ').join(' ');
  return s.trim();
}
function axState(m){
  const done = !!axToDate(m.actualEndDate || m.actualEnd || m.completedAt || m.doneDate);
  if(done) return 'completed';
  const started = !!axToDate(m.actualStartDate || m.actualStart || m.startedAt || m.startActual);
  return started ? 'ongoing' : 'pending';
}
function axTrack(m){
  const pEnd = axToDate(m.endDate || m.plannedEnd || m.end);
  const aEnd = axToDate(m.actualEndDate || m.actualEnd || m.completedAt || m.doneDate);
  const today = new Date();
  if(!pEnd || isNaN(+pEnd)) return {key:'unknown', label:'On Track'};
  if(aEnd && !isNaN(+aEnd)) return (aEnd <= pEnd) ? {key:'ontrack', label:'On Track'} : {key:'delayed', label:'Delayed'};
  return (today > pEnd) ? {key:'delayed', label:'Delayed'} : {key:'ontrack', label:'On Track'};
}

function buildAdvancedMilestoneUX(milestones){
  const list = Array.isArray(milestones) ? milestones : [];
  if(!list.length) return "<div class='text-sm text-slate-300'>No milestones</div>";

  let lastCompleted=-1;
  let counts={completed:0,ongoing:0,pending:0,delayed:0};
  for(let i=0;i<list.length;i++){
    const st=axState(list[i]);
    counts[st] = (counts[st]||0)+1;
    if(st==='completed') lastCompleted=i;
    const tr=axTrack(list[i]);
    if(tr.key==='delayed') counts.delayed++;
  }
  const denom = Math.max(1,(list.length-1));
  const fillPct = lastCompleted<0?0:Math.max(0,Math.min(100,(lastCompleted/denom)*100));
  const doneCount = lastCompleted<0?0:(lastCompleted+1);

  let current='';
  for(let i=0;i<list.length;i++){
    if(axState(list[i])!=='completed'){
      const raw = list[i].phase || list[i].Activity || list[i].name || ('Milestone ' + (i+1));
      current = axLabel(raw);
      break;
    }
  }
  const overall = counts.delayed>0 ? {cls:'bad', label:'Delayed'} : {cls:'good', label:'On Track'};

  const checkSvg = '<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">'
    + '<path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>'
    + '</svg>';

  const trackStyle = "style=\"--n:" + list.length + ";\"";
  const timeline = list.map((m,i)=>{
    const st=axState(m);
    const raw=m.phase||m.Activity||m.name||('Milestone '+(i+1));
    const label=esc(axLabel(raw));
    const icon = (st==='completed') ? checkSvg : (st==='ongoing' ? checkSvg : '');
    return "<div class='ax-item'>"
      + "<div class='ax-dot " + st + "'>" + icon + "</div>"
      + "<div class='ax-label'>" + label + "</div>"
      + "</div>";
  }).join('');

  const rows = list.map((m,i)=>{
    const raw=m.phase||m.Activity||m.name||('Milestone '+(i+1));
    const name=esc(axLabel(raw));
    const st=axState(m);
    const tr=axTrack(m);
    const pS=axFmt(m.startDate||m.plannedStart||m.start);
    const pE=axFmt(m.endDate||m.plannedEnd||m.end);
    const aS=axFmt(m.actualStartDate||m.actualStart||m.startedAt||m.startActual);
    const aE=axFmt(m.actualEndDate||m.actualEnd||m.completedAt||m.doneDate);
    const owner=esc(m.owner||m.Owner||m.ownerName||m.ownerId||'-');
    const note=esc(m.note||m.notes||m.remark||m.remarks||m.risk||'');

    const stLabel = (st==='completed')?'Completed':(st==='ongoing'?'In-Progress':'Planned');

    return "<div class='ax-row' data-ax='row' data-name='"+name.toLowerCase()+"' data-status='"+st+"' data-track='"+tr.key+"' "
      + "data-ps='"+esc(pS)+"' data-pe='"+esc(pE)+"' data-as='"+esc(aS)+"' data-ae='"+esc(aE)+"' data-owner='"+owner+"' data-note='"+note+"' data-title='"+name+"'>"
      + "<div class='ax-top'>"
      +   "<div>"
      +     "<div class='ax-name'>" + name + "</div>"
      +     "<div class='ax-sub'>Planned: " + esc(pS) + " → " + esc(pE) + "</div>"
      +   "</div>"
      +   "<div class='ax-pills'>"
      +     "<span class='ax-pill " + st + "'>" + stLabel + "</span>"
      +     "<span class='ax-pill " + tr.key + "'>" + tr.label + "</span>"
      +   "</div>"
      + "</div>"
      + "<div class='ax-actions'>"
      +   "<button type='button' class='ax-btn' data-ax-open='1'>View details</button>"
      +   "<button type='button' class='ax-btn primary' data-ax-open='1'>Open</button>"
      + "</div>"
      + "</div>";
  }).join('');

  return "<div class='ax-card' data-ax-root='1'>"
    + "<div class='ax-head'>"
    +   "<div class='ax-title'>Project Milestones - Application Tracker</div>"
    +   "<div class='ax-kpis'>"
    +     "<span class='ax-kpi neu'>Completed " + doneCount + "/" + list.length + "</span>"
    +     (current ? ("<span class='ax-kpi gray'>Current: " + esc(current) + "</span>") : "")
    +     "<span class='ax-kpi " + overall.cls + "'>" + overall.label + "</span>"
    +   "</div>"
    +   "<div class='ax-tabs'>"
    +     "<button type='button' class='ax-tab active' data-ax-tab='overview'>Overview</button>"
    +     "<button type='button' class='ax-tab' data-ax-tab='milestones'>Milestones</button>"
    +   "</div>"
    + "</div>"

    + "<div data-ax-panel='overview'>"
    +   "<div class='ax-scroll'>"
    +     "<div class='ax-track' " + trackStyle + ">"
    +       "<div class='ax-line'></div>"
    +       "<div class='ax-linefill' style='width:" + fillPct + "%'></div>"
    +       "<div class='ax-items'>" + timeline + "</div>"
    +     "</div>"
    +   "</div>"
    + "</div>"

    + "<div data-ax-panel='milestones' style='display:none'>"
    +   "<div class='ax-controls'>"
    +     "<div class='ax-search'><span style='font-weight:900;color:#64748b;'>Search</span><input placeholder='Milestone…' data-ax-search='1'/></div>"
    +     "<div class='ax-filters'>"
    +       "<button type='button' class='ax-filter active' data-ax-filter='all'>All</button>"
    +       "<button type='button' class='ax-filter' data-ax-filter='delayed'>Delayed</button>"
    +       "<button type='button' class='ax-filter' data-ax-filter='ongoing'>In-Progress</button>"
    +       "<button type='button' class='ax-filter' data-ax-filter='completed'>Completed</button>"
    +     "</div>"
    +   "</div>"
    +   "<div class='ax-list'>" + rows + "</div>"
    + "</div>"

    + "<div class='ax-overlay' data-ax-overlay='1'></div>"
    + "<div class='ax-sheet' data-ax-sheet='1'>"
    +   "<div class='ax-sheethead'>"
    +     "<div class='ax-sheettitle' data-ax-sheettitle='1'>Details</div>"
    +     "<button type='button' class='ax-close' data-ax-close='1'>Close</button>"
    +   "</div>"
    +   "<div class='ax-sheetbody'>"
    +     "<div class='ax-grid'>"
    +       "<div class='ax-box planned'><h6>Planned</h6><p data-ax-planned='1'>-</p></div>"
    +       "<div class='ax-box actual'><h6>Actual</h6><p data-ax-actual='1'>-</p></div>"
    +       "<div class='ax-box owner' style='grid-column:1/-1;'><h6>Owner</h6><p data-ax-owner='1'>-</p></div>"
    +     "</div>"
    +     "<div class='ax-note' data-ax-note='1' style='display:none'></div>"
    +   "</div>"
    + "</div>"
    + "</div>";
}

function wireAdvancedMilestoneUX(root){
  if(!root || root.__axWired) return;
  root.__axWired = true;

  const overlay = root.querySelector('[data-ax-overlay="1"]');
  const sheet = root.querySelector('[data-ax-sheet="1"]');
  const closeBtn = root.querySelector('[data-ax-close="1"]');

  function openSheet(row){
    if(!row) return;
    const title = row.getAttribute('data-title') || 'Details';
    const ps = row.getAttribute('data-ps') || '-';
    const pe = row.getAttribute('data-pe') || '-';
    const asd = row.getAttribute('data-as') || '-';
    const ae = row.getAttribute('data-ae') || '-';
    const owner = row.getAttribute('data-owner') || '-';
    const note = row.getAttribute('data-note') || '';

    root.querySelector('[data-ax-sheettitle="1"]').textContent = title;
    root.querySelector('[data-ax-planned="1"]').innerHTML = 'S: ' + esc(ps) + '<br/>E: ' + esc(pe);
    root.querySelector('[data-ax-actual="1"]').innerHTML = 'S: ' + esc(asd) + '<br/>E: ' + esc(ae);
    root.querySelector('[data-ax-owner="1"]').textContent = owner;

    const noteEl = root.querySelector('[data-ax-note="1"]');
    if(note && note.trim()){
      noteEl.style.display = '';
      noteEl.textContent = 'Note: ' + note;
    }else{
      noteEl.style.display = 'none';
      noteEl.textContent = '';
    }

    overlay.classList.add('open');
    sheet.classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeSheet(){
    overlay.classList.remove('open');
    sheet.classList.remove('open');
    document.body.style.overflow = '';
  }

  overlay && overlay.addEventListener('click', closeSheet);
  closeBtn && closeBtn.addEventListener('click', closeSheet);

  root.addEventListener('click', (e)=>{
    const tab = e.target.closest && e.target.closest('[data-ax-tab]');
    if(tab){
      const key = tab.getAttribute('data-ax-tab');
      root.querySelectorAll('.ax-tab').forEach(b=>b.classList.toggle('active', b===tab));
      root.querySelectorAll('[data-ax-panel]').forEach(p=>{
        p.style.display = (p.getAttribute('data-ax-panel')===key) ? '' : 'none';
      });
      return;
    }

    const openBtn = e.target.closest && e.target.closest('[data-ax-open]');
    if(openBtn){
      const row = e.target.closest('[data-ax="row"]');
      openSheet(row);
      return;
    }

    const fbtn = e.target.closest && e.target.closest('[data-ax-filter]');
    if(fbtn){
      const key = fbtn.getAttribute('data-ax-filter');
      root.querySelectorAll('.ax-filter').forEach(b=>b.classList.toggle('active', b===fbtn));
      root.setAttribute('data-ax-filter-active', key);
      applyFilter(root);
    }
  });

  const search = root.querySelector('[data-ax-search="1"]');
  if(search){
    search.addEventListener('input', ()=>applyFilter(root));
  }

  function applyFilter(rootEl){
    const q = (rootEl.querySelector('[data-ax-search="1"]').value||'').trim().toLowerCase();
    const flt = rootEl.getAttribute('data-ax-filter-active') || 'all';
    rootEl.querySelectorAll('[data-ax="row"]').forEach(row=>{
      const name = (row.getAttribute('data-name')||'');
      const st = row.getAttribute('data-status')||'';
      const tr = row.getAttribute('data-track')||'';
      let ok = (!q || name.indexOf(q) !== -1);
      if(flt==='delayed') ok = ok && (tr==='delayed');
      else if(flt==='ongoing') ok = ok && (st==='ongoing');
      else if(flt==='completed') ok = ok && (st==='completed');
      row.style.display = ok ? '' : 'none';
    });
  }
}

function renderDetailsFromState(state){
  // Normalize state shape across versions
  const root = (state && (state.state || state.data || state)) || state || {};
  const exec = (root.executive || root.exec || root) || {};


  // Milestones + Application Tracker (collapsed)
  const milestones = Array.isArray(exec.milestones) ? exec.milestones : (exec.milestones && Array.isArray(exec.milestones.items) ? exec.milestones.items : []);
  let axHtml = '';
  try{ axHtml = buildAdvancedMilestoneUX(milestones); }catch(e){ axHtml=''; }
  const userStories = Array.isArray(exec.userStories) ? exec.userStories : (exec.userStories && Array.isArray(exec.userStories.items) ? exec.userStories.items : []);
  const bugs = Array.isArray(exec.bugs) ? exec.bugs : (exec.bugs && Array.isArray(exec.bugs.items) ? exec.bugs.items : []);

  const usTotal = userStories.length;
  const usOpen = countOpen(userStories);
  const bugTotal = bugs.length;
  const bugOpen = countOpen(bugs);

  const toDate = (v)=>{ try{ return v? new Date(v): null; }catch{ return null; } };
  const today = new Date();
  function milestoneStatus(m){
    const plannedEnd = toDate(m.endDate || m.plannedEnd || m.end);
    const actualEnd = toDate(m.actualEndDate || m.actualEnd);
    const actualStart = toDate(m.actualStartDate || m.actualStart);
    if(actualEnd) return { label:'Completed', cls:'bg-green-400/10 border-green-400/30 text-green-200' };
    if(plannedEnd && today > plannedEnd) return { label:'Delayed', cls:'bg-red-400/10 border-red-400/30 text-red-200' };
    if(actualStart) return { label:'In Progress', cls:'bg-amber-400/10 border-amber-400/30 text-amber-200' };
    return { label:'Planned', cls:'bg-slate-400/10 border-white/10 text-slate-200' };
  }

  const msStats = { total: milestones.length, completed:0, delayed:0, inprogress:0, planned:0 };
  const msCards = milestones.length
    ? milestones.slice(0, 12).map(m => {
        const phase = esc(m.phase || m.Activity || m.name || 'Milestone');
        const start = esc(m.startDate || m.plannedStart || m.start || '—');
        const end = esc(m.endDate || m.plannedEnd || m.end || '—');
        const actS = esc(m.actualStartDate || m.actualStart || '—');
        const actE = esc(m.actualEndDate || m.actualEnd || '—');
        const st = milestoneStatus(m);
        if(st.label==='Completed') msStats.completed++; else if(st.label==='Delayed') msStats.delayed++; else if(st.label==='In Progress') msStats.inprogress++; else msStats.planned++;
        return `<div class='rounded-xl border border-white/10 bg-white/5 p-3'>
          <div class='flex items-start justify-between gap-2'>
            <div class='min-w-0'>
              <div class='text-sm font-semibold text-slate-100 break-words'>${phase}</div>
              <div class='mt-1 text-xs text-slate-400'>Planned: ${start} → ${end}</div>
              <div class='mt-0.5 text-xs text-slate-400'>Actual: ${actS} → ${actE}</div>
            </div>
            <span class='shrink-0 px-2 py-1 rounded-full border text-xs font-semibold ${st.cls}'>${st.label}</span>
          </div>
        </div>`;
      }).join('')
    : `<div class='text-sm text-slate-300'>No milestones</div>`;

  // Task Discipline (L1 visible, L2 collapsed)
  const taskDisciplines = Array.isArray(exec.taskDisciplines) ? exec.taskDisciplines : (exec.taskDisciplines && Array.isArray(exec.taskDisciplines.items) ? exec.taskDisciplines.items : []);
  const l2Columns = Array.isArray(exec.l2Columns) ? exec.l2Columns : (exec.l2Columns && Array.isArray(exec.l2Columns.items) ? exec.l2Columns.items : []);
  const l2Data = (exec.l2Data && typeof exec.l2Data === 'object') ? exec.l2Data : (root.l2Data && typeof root.l2Data === 'object' ? root.l2Data : {});

  const l1Rows = taskDisciplines.length
    ? taskDisciplines.map(d => {
        const disc = esc(d.discipline || '');
        const total = d.totalTasks ?? 0;
        const open = d.openTasks ?? 0;
        const closed = d.closedTasks ?? 0;
        const hold = d.holdTasks ?? 0;
        const grand = d.grandTotal ?? (open + closed + hold);
        return `
          <tr class='border-t border-white/10'>
            <td class='py-2 pr-3 font-medium text-slate-200'>${disc}</td>
            <td class='py-2 text-center text-slate-200'>${total}</td>
            <td class='py-2 text-center text-slate-200'>${open}</td>
            <td class='py-2 text-center text-slate-200'>${closed}</td>
            <td class='py-2 text-center text-slate-200'>${hold}</td>
            <td class='py-2 text-center text-slate-200 font-semibold'>${grand}</td>
          </tr>`;
      }).join('')
    : `<tr><td class='py-2 text-slate-300' colspan='6'>No discipline data</td></tr>`;

  const l2Cols = l2Columns.length ? l2Columns : [{id:'c1',name:'Col 1'},{id:'c2',name:'Col 2'},{id:'c3',name:'Col 3'}];
  const discKeys = Object.keys(l2Data).length ? Object.keys(l2Data) : ['DMT','Tech','Content Mgmt.','QA'];
  const l2Html = discKeys.map(disc => {
    const rows = Array.isArray(l2Data[disc]) ? l2Data[disc] : [];
    const head = l2Cols.map(c => `<th class='px-3 py-2 text-center text-xs font-semibold text-slate-400 border-l border-white/10'>${esc(c.name)}</th>`).join('');
    const body = rows.length ? rows.map(r => {
      const feat = esc(r.feature || r.Feature || '');
      const cells = l2Cols.map(c => `<td class='px-3 py-2 text-center text-slate-200 border-l border-white/10'>${esc(r[c.id] || '')}</td>`).join('');
      return `<tr class='border-t border-white/10'><td class='px-3 py-2 text-slate-200 font-medium'>${feat}</td>${cells}</tr>`;
    }).join('') : `<tr><td class='px-3 py-2 text-slate-300' colspan='${1 + l2Cols.length}'>No L2 items</td></tr>`;

    return `<div class='rounded-xl border border-white/10 bg-white/5 overflow-hidden'>
      <div class='px-3 py-2 text-xs font-semibold text-slate-300 bg-white/5 border-b border-white/10'>${esc(disc)}</div>
      <div class='overflow-auto'>
        <table class='min-w-full text-sm'>
          <thead>
            <tr>
              <th class='px-3 py-2 text-left text-xs font-semibold text-slate-400'>Feature/Scope</th>
              ${head}
            </tr>
          </thead>
          <tbody>${body}</tbody>
        </table>
      </div>
    </div>`;
  }).join('');

  return `
    <div class='rounded-xl border border-white/10 bg-white/5 overflow-hidden'>
      <button type='button' data-inner-toggle='msapp' class='w-full flex items-center justify-between px-3 py-3 text-left'>
        <span>
          <div class='text-xs text-slate-400 font-semibold uppercase tracking-wide'>Milestones & Application Tracker</div>
          <div class='mt-1 text-sm text-slate-200'>US: <b>${usTotal}</b> (Open ${usOpen}) • Bugs: <b>${bugTotal}</b> (Open ${bugOpen})</div>
          

        </span>
        <span class='text-slate-400 text-sm'>▼</span>
      </button>
      <div data-inner-panel='msapp' class='hidden px-3 pb-3'>
  ${axHtml}

        <div class='grid grid-cols-1 sm:grid-cols-2 gap-3'>${msCards}</div>
      </div>
    </div>

    <div class='rounded-xl border border-white/10 bg-white/5 p-3'>
      <div class='text-xs text-slate-400 font-semibold uppercase tracking-wide'>Task Discipline (L1)</div>
      <div class='mt-2 overflow-auto'>
        <table class='min-w-full text-sm'>
          <thead>
            <tr class='text-xs text-slate-400'>
              <th class='py-2 pr-3 text-left'>Discipline</th>
              <th class='py-2 text-center'>Total</th>
              <th class='py-2 text-center'>Open</th>
              <th class='py-2 text-center'>Closed</th>
              <th class='py-2 text-center'>Hold</th>
              <th class='py-2 text-center'>Grand</th>
            </tr>
          </thead>
          <tbody>${l1Rows}</tbody>
        </table>
      </div>

      <button type='button' data-inner-toggle='l2' class='mt-3 w-full flex items-center justify-between px-3 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10'>
        <span class='text-sm text-slate-200 font-medium'>L2 Details (click to show/hide)</span>
        <span class='text-slate-400 text-sm'>▼</span>
      </button>
      <div data-inner-panel='l2' class='hidden mt-3 space-y-3'>
        ${l2Html}
      </div>
    </div>
  `;
}

function wireExecBoardToggles(){
  const grid = document.getElementById('grid');
  if(!grid || grid.__wired) return;
  grid.__wired = true;

  grid.addEventListener('click', async (e)=>{
    // Inner toggles inside an opened details panel
    const innerBtn = e.target.closest && e.target.closest('[data-inner-toggle]');
    if(innerBtn){
      const key = innerBtn.getAttribute('data-inner-toggle');
      const root = innerBtn.closest('[data-loaded]') || innerBtn.closest('div');
      const innerPanel = root && root.querySelector ? root.querySelector('[data-inner-panel="' + key + '"]') : null;
      if(innerPanel){ innerPanel.classList.toggle('hidden'); return; }
    }

    // Outer Details toggle per card
    const btn = e.target.closest && e.target.closest('[data-toggle]');
    if(!btn) return;
    const id = btn.getAttribute('data-toggle');
    const panel = document.getElementById(id);
    if(!panel) return;

    const willOpen = panel.classList.contains('hidden');
    panel.classList.toggle('hidden');
    btn.textContent = panel.classList.contains('hidden') ? 'Details' : 'Hide';

    if(willOpen && panel.getAttribute('data-loaded') !== '1'){
      const dash = panel.getAttribute('data-dash') || btn.getAttribute('data-dash');
      panel.innerHTML = `<div class='text-sm text-slate-300'>Loading…</div>`;
      try{
        const st = await fetchDashState(dash);
        panel.innerHTML = renderDetailsFromState(st);
      try{ const r = panel.querySelector('[data-ax-root="1"]'); if(r) wireAdvancedMilestoneUX(r); }catch(e){}
      }catch(err){
        panel.innerHTML = `<div class='text-sm text-red-200 bg-red-400/10 border border-red-400/30 rounded-xl p-3'>Preview failed: ${esc(err.message || String(err))}</div>`;
      }
      panel.setAttribute('data-loaded','1');
    }
  });
}
wireExecBoardToggles();
load().catch(e=>{ const err=document.getElementById('err'); err.textContent=e.message||String(e); err.classList.remove('hidden'); document.getElementById('status').textContent='—'; });
</script>

</body></html>
