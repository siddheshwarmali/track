
<!DOCTYPE html><html lang='en'>
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Board</title>
<!-- TW_BUILD_STAMP: 2026-01-16 15:28 IST (rename-db-fix) -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    
    <!-- html2canvas for Report Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .modal { display: none; }
        .modal.open { display: flex; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
        .hidden-by-report { display: none !important; }
        
        .clickable-cell:hover { text-decoration: underline; cursor: pointer; color: #2563eb; font-weight: 600; }
        [contenteditable] { padding: 4px 8px; border-radius: 4px; transition: all 0.2s; border: 1px solid transparent; }
        [contenteditable]:hover { background-color: #f8fafc; border-color: #e2e8f0; }
        [contenteditable]:focus { outline: none; background-color: #eff6ff; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .l3-row:hover { background-color: #f8fafc; }
        .l3-row:hover .delete-btn { opacity: 1; pointer-events: auto; }
        .delete-btn { opacity: 0; transition: opacity 0.2s; }
    </style>

    <style>
      @keyframes ghspin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
      /* Hide Clear Storage button */
      button[onclick^="wsClearLocalStorage"], button[onclick="wsClearLocalStorage()"] { display:none !important; }
    </style>

<script>
  async function twJson(url, opt){
    const r = await fetch(url, Object.assign({headers:{'Accept':'application/json','Content-Type':'application/json'}}, opt||{}));
    const t = await r.text();
    let j={};
    try{ j=JSON.parse(t||'{}'); }catch{ j={error:t}; }
    if(!r.ok) throw new Error(j.error||j.message||t||('HTTP '+r.status));
    return j;
  }

  async function twInit(){
    const pill=document.getElementById('tw-userpill');
    const mgr=document.getElementById('tw-usermgr');
    const lo=document.getElementById('tw-logout');
    try{
      const me = await twJson('/api/auth/me');
      if(!me || !me.authenticated){
        const next=encodeURIComponent(location.pathname+location.search+location.hash);
        location.replace('/login.html?next='+next);
        return;
      }
      const role = me.role || 'viewer';
      document.body.classList.remove('role-admin','role-creator','role-viewer');
      document.body.classList.add('role-'+role);
      if(pill) pill.textContent = (me.userId||'User') + ' • ' + role;
      if(mgr) mgr.classList.toggle('hidden', role!=='admin');
      if(lo) lo.onclick = async ()=>{ try{ await twJson('/api/auth/logout', {method:'POST'});}catch(e){} location.href='/login.html'; };
    }catch(e){
      const next=encodeURIComponent(location.pathname+location.search+location.hash);
      location.replace('/login.html?next='+next);
    }
  }
  window.addEventListener('DOMContentLoaded', ()=>{ twInit(); });
</script>

</head>
<body class='bg-slate-950 text-slate-100'>
  <div class='sticky top-0 z-40 bg-slate-950/70 backdrop-blur border-b border-white/10'>
    <div class='max-w-6xl mx-auto px-4 py-4 flex flex-wrap gap-3 items-center justify-between'>
      <div>
        <div class='text-lg font-extrabold'>Executive Board</div>
        <div class='text-xs text-slate-400'>All published dashboards you can access — card view</div>
      </div>
      <div class='flex flex-wrap gap-2 items-center'>
        <div class='flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-2 text-sm'>
          <span class='text-slate-400 text-xs'>Sort</span>
          <select id='sort' class='bg-transparent outline-none text-sm'>
            <option value='newest'>Newest</option>
            <option value='oldest'>Oldest</option>
            <option value='name_asc'>Name A→Z</option>
            <option value='name_desc'>Name Z→A</option>
          </select>
        </div>
        <div class='flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-2 text-sm'>
          <span class='text-slate-400 text-xs'>Search</span>
          <input id='q' placeholder='Project name…' class='bg-transparent outline-none text-sm w-44' />
        </div>
        <a href='/index.html' class='px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm'>Back</a>
      </div>
    </div>
  </div>

  <div class='max-w-6xl mx-auto px-4 py-4'>
    <div id='status' class='text-sm text-slate-400'>Loading…</div>
    <div id='err' class='hidden mt-3 p-3 rounded-xl border border-red-400/30 bg-red-400/10 text-red-200 text-sm'></div>
    <div id='grid' class='mt-4 grid grid-cols-1 gap-4'></div>
  </div>

<script>
async function jget(url){
  const r = await fetch(url, { headers:{'Accept':'application/json'} });
  const t = await r.text();
  let j={}; try{ j=JSON.parse(t||'{}'); }catch{ j={}; }
  if(!r.ok) throw new Error(j.error || `Request failed (${r.status})`);
  return j;
}
function fmt(iso){ try{ return new Date(iso).toLocaleString(); }catch{ return iso||'—'; } }
function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

function card(d){
  const ms = (d.milestones?.items||[]).map(x=>`<li class='text-sm text-slate-300'>• ${esc(x)}</li>`).join('');
  return `
  <div class='rounded-2xl border border-white/10 bg-white/5 overflow-hidden'>
    <div class='p-4 flex flex-wrap gap-3 items-start justify-between border-b border-white/10'>
      <div>
        <div class='text-base font-bold'>${esc(d.name||d.id)}</div>
        <div class='mt-2 flex flex-wrap gap-2 text-xs text-slate-300'>
          <span class='px-2 py-1 rounded-full border border-indigo-400/30 bg-indigo-400/10'>Published: ${fmt(d.publishedAt||d.updatedAt)}</span>
          <span class='px-2 py-1 rounded-full border border-white/10 bg-white/5'>Owner: ${esc(d.ownerId||'')}</span>
        </div>
      </div>
      <div class='flex flex-wrap gap-2 text-xs text-slate-300'>
        <span class='px-2 py-1 rounded-full border border-white/10 bg-white/5'>Milestones: <b>${d.milestones?.count||0}</b></span>
        <span class='px-2 py-1 rounded-full border border-white/10 bg-white/5'>US: <b>${d.application?.userStories||0}</b></span>
        <span class='px-2 py-1 rounded-full border border-white/10 bg-white/5'>Bugs: <b>${d.application?.bugs||0}</b></span>
        <span class='px-2 py-1 rounded-full border border-white/10 bg-white/5'>Disciplines: <b>${d.discipline?.disciplines||0}</b></span>
      </div>
    </div>

    <div class='p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3'>
      <div class='rounded-xl border border-white/10 bg-white/5 p-3'>
        <div class='text-xs text-slate-400 font-semibold uppercase tracking-wide'>Overall Summary</div>
        <div class='mt-2 text-sm text-slate-200 leading-relaxed'>${esc(d.summary||'No summary')}</div>
      </div>
      <div class='rounded-xl border border-white/10 bg-white/5 p-3'>
        <div class='text-xs text-slate-400 font-semibold uppercase tracking-wide'>Milestones</div>
        <ul class='mt-2 space-y-1'>${ms || "<li class='text-sm text-slate-300'>No milestones</li>"}</ul>
      </div>
      <div class='rounded-xl border border-white/10 bg-white/5 p-3'>
        <div class='text-xs text-slate-400 font-semibold uppercase tracking-wide'>Application</div>
        <div class='mt-2 text-sm text-slate-200'>US: <b>${d.application?.userStories||0}</b> (Open ${d.application?.usOpen||0})</div>
        <div class='mt-1 text-sm text-slate-200'>Bugs: <b>${d.application?.bugs||0}</b> (Open ${d.application?.bugsOpen||0})</div>
      </div>
      <div class='rounded-xl border border-white/10 bg-white/5 p-3'>
        <div class='text-xs text-slate-400 font-semibold uppercase tracking-wide'>Task Discipline</div>
        <div class='mt-2 text-sm text-slate-200'>Disciplines: <b>${d.discipline?.disciplines||0}</b></div>
        <div class='mt-1 text-sm text-slate-200'>Pending: <b>${d.discipline?.pending||0}</b></div>
      </div>
    </div>

    <div class='px-4 pb-4'>
      <a href='/index.html?dash=${encodeURIComponent(d.id)}' class='inline-flex px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 text-sm'>Open Dashboard</a>
    </div>
  </div>`;
}

function applySearch(){
  const q = (document.getElementById('q').value||'').trim().toLowerCase();
  document.querySelectorAll('#grid [data-name]').forEach(el=>{
    const n = el.getAttribute('data-name')||'';
    el.style.display = (!q || n.includes(q)) ? '' : 'none';
  });
}

async function load(){
  const status=document.getElementById('status');
  const err=document.getElementById('err');
  err.classList.add('hidden');
  status.textContent='Checking access…';
  const me = await jget('/api/auth/me');
  if(!me.authenticated){ location.href='/login.html?next='+encodeURIComponent('/executive-board.html'); return; }
  const perms = me.permissions || {};
  if(!(me.role==='admin' || perms.executiveBoard)){
    err.textContent='Access denied: Admin has not granted Executive Board access.';
    err.classList.remove('hidden');
    status.textContent='—';
    return;
  }
  status.textContent='Loading…';
  const sort=document.getElementById('sort').value;
  const data = await jget('/api/board?sort='+encodeURIComponent(sort));
  const items = Array.isArray(data.items)?data.items:[];
  const grid=document.getElementById('grid');
  grid.innerHTML = items.map(d=>`<div data-name='${esc((d.name||'').toLowerCase())}'>${card(d)}</div>`).join('') || "<div class='text-slate-400 text-sm'>No published dashboards available.</div>";
  status.textContent = `Showing ${items.length} dashboard(s).`;
  applySearch();
}

document.getElementById('sort').addEventListener('change', load);
document.getElementById('q').addEventListener('input', applySearch);
load().catch(e=>{ const err=document.getElementById('err'); err.textContent=e.message||String(e); err.classList.remove('hidden'); document.getElementById('status').textContent='—'; });
</script>

</body></html>
